import{dashboardData as t,labelDistContainer as n,general as l}from"../modules/dashboard-objects.js";import{labelDistributionElement as r,labelDistributionMonth as i,labelDistributionTimeFrame as a,labelDistributionWeek as o,labelDistributionYear as s,labelLinesContainer as c,labelNamesContainer as D,labelTimesContainer as M,leftLabelDistributionArrow as d,metricDistributionMonth as e,metricDistributionTimeFrame as m,metricDistributionWeek as u,metricDistributionYear as Y,rightLabelDistributionArrow as b,rightLabelDistributionArrowGray as f}from"../modules/dashboard-elements.js";import{timeConvert as h}from"../modules/index-objects.js";import{sessionState as p}from"../modules/state-objects.js";function populateLabelDistContainer(){setBounds(n,a,b,f),L(t,n)}function checkViewportWidth(){window.innerWidth<=1385?(o.innerText="W",i.innerText="M",s.innerText="Y"):(o.innerText="Week",i.innerText="Month",s.innerText="Year")}function y(e,t){var n,r=e.noteData.labels;let o={};for(n in r)r.hasOwnProperty(n)&&(o[n]=0);var i,a=e.dailyArr;for(let e=0;e<a.length;e++)if(moment(a[e].date,"YYYY-MM-DD").isSameOrAfter(moment(t.lowerBound,"YYYY-MM-DD"))&&moment(a[e].date,"YYYY-MM-DD").isSameOrBefore(moment(t.upperBound,"YYYY-MM-DD"))){var l,s=a[e].labelTimes;for(l in s)o.hasOwnProperty(l)&&(o[l]+=s[l])}let d=[],m=0,u=!1;for(i in o)m+=o[i],0===o[i]&&d.push(i);0===m&&(u=!0);let Y=0;Object.keys(o).forEach(e=>{e=Math.round(o[e]/m*100);e>Y&&(Y=e)}),Object.keys(o).forEach(e=>{var t=o[e]/h.msPerHour,n=Math.floor(t),t=Math.round(60*(t-n)),r=Math.round(o[e]/m*100);let i;i=d.includes(e)?"0h 0m (0%)":n+`h ${t}m (${r}%)`,document.getElementById("labelTime-"+e).innerText=i;let a;a=u?0:Math.round(r/Y*100),document.getElementById("labelLine-"+e).style.width=a+"%"})}function L(l,t){D.innerHTML="",c.innerHTML="",M.innerHTML="";var e,n=l.noteData.labels;let s={};for(e in n)n.hasOwnProperty(e)&&(s[e]=0);var r,i=l.dailyArr;for(let e=0;e<i.length;e++)if(moment(i[e].date,"YYYY-MM-DD").isSameOrAfter(moment(t.lowerBound,"YYYY-MM-DD"))&&moment(i[e].date,"YYYY-MM-DD").isSameOrBefore(moment(t.upperBound,"YYYY-MM-DD"))){var a,o=i[e].labelTimes;for(a in o)s.hasOwnProperty(a)&&(s[a]+=o[a])}let d=[],m=0,u=!1;for(r in s)m+=s[r],0===s[r]&&d.push(r);0===m&&(u=!0);let Y=0;Object.keys(s).forEach(e=>{e=Math.round(s[e]/m*100);e>Y&&(Y=e)}),Object.keys(s).forEach(e=>{let t=l.noteData.labels[e];20<t.length&&(t=t.slice(0,20)+"...");var n=document.createElement("div"),n=(n.id="labelName-"+e,n.classList.add("labelName"),n.innerText=t,D.appendChild(n),s[e]/h.msPerHour),r=Math.floor(n),n=Math.round(60*(n-r)),i=Math.round(s[e]/m*100);let a;a=d.includes(e)?"0h 0m (0%)":r+`h ${n}m (${i}%)`;r=document.createElement("div"),r.classList.add("labelTime"),r.id="labelTime-"+e,r.innerText=a,M.appendChild(r),n=document.createElement("div"),n.classList.add("labelLine"),n.id="labelLine-"+e,r=document.createElement("div");r.classList.add("labelLineContainer"),r.id="labelLineContainer-"+e;let o;o=u?0:Math.round(i/Y*100),n.style.width=o+"%",r.appendChild(n),c.appendChild(r)})}function alterBounds(e,t,n,r,i){var a=moment(l.currentDay,"YYYY-MM-DD"),o=moment(t.upperBound,"YYYY-MM-DD");"shiftup"===e&&o.isBefore(a)?(t.lowerBound=moment(t.lowerBound,"YYYY-MM-DD").add(1,t.timeFrame).format("YYYY-MM-DD"),"month"===t.timeFrame?t.upperBound=moment(t.lowerBound,"YYYY-MM-DD").endOf("month").format("YYYY-MM-DD"):t.upperBound=moment(t.upperBound,"YYYY-MM-DD").add(1,t.timeFrame).format("YYYY-MM-DD")):"shiftdown"===e&&(t.lowerBound=moment(t.lowerBound,"YYYY-MM-DD").subtract(1,t.timeFrame).format("YYYY-MM-DD"),"month"===t.timeFrame?t.upperBound=moment(t.lowerBound,"YYYY-MM-DD").endOf("month").format("YYYY-MM-DD"):t.upperBound=moment(t.upperBound,"YYYY-MM-DD").subtract(1,t.timeFrame).format("YYYY-MM-DD")),setRightArrowType(t,a,r,i),n&&displayTimeFrame(t,n)}async function setBounds(e,t,n,r){var i=moment(l.currentDay,"YYYY-MM-DD"),a=i.clone().startOf(e.timeFrame).format("YYYY-MM-DD"),o=i.clone().endOf(e.timeFrame).format("YYYY-MM-DD");e.lowerBound=a,e.upperBound=o,setRightArrowType(e,i,n,r),t&&displayTimeFrame(e,t)}function setRightArrowType(e,t,n,r){moment(e.upperBound,"YYYY-MM-DD").isBefore(t)?(n.style.display="flex",r.style.display="none"):(n.style.display="none",r.style.display="flex")}function displayTimeFrame(e,t){let n;n="week"===e.timeFrame?w(e.lowerBound,e.upperBound):("month"===e.timeFrame?g:v)(e.lowerBound),t.innerText=n,mainChartsSummaryHeader.innerText=n}function v(e){return F(e).getFullYear()}function g(e){var t=(new Date).getFullYear(),e=F(e),n=["January","February","March","April","May","June","July","August","September","October","November","December"][e.getMonth()],e=e.getFullYear();return e===t?""+n:n+" '"+String(e).slice(-2)}function w(e,t){var n=["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"],r=(new Date).getFullYear(),e=F(e),t=F(t),i=n[e.getMonth()],a=B(e.getDate()),e=e.getFullYear(),n=n[t.getMonth()],o=B(t.getDate()),t=t.getFullYear();return e===r&&t===r?i===n?i+` ${a} - `+o:i+` ${a} - ${n} `+o:e===t?(r=String(e).slice(-2),i===n?i+` ${a} - ${o} '`+r:i+` ${a} - ${n} ${o} '`+r):i+` ${a} '${String(e).slice(-2)} - ${n} ${o} '`+String(t).slice(-2)}function B(e){if(3<e&&e<21)return e+"th";switch(e%10){case 1:return e+"st";case 2:return e+"nd";case 3:return e+"rd";default:return e+"th"}}function F(e){var[e,t,n]=e.split("-").map(Number);return new Date(e,t-1,n)}document.addEventListener("DOMContentLoaded",function(){window.addEventListener("resize",checkViewportWidth)}),document.addEventListener("stateUpdated",function(){var e;p.loggedIn?(o.addEventListener("click",function(){o.classList.add("labelDistributionSelected"),i.classList.remove("labelDistributionSelected"),s.classList.remove("labelDistributionSelected"),n.timeFrame="week",setBounds(n,a,b,f),y(t,n)}),i.addEventListener("click",function(){i.classList.add("labelDistributionSelected"),o.classList.remove("labelDistributionSelected"),s.classList.remove("labelDistributionSelected"),n.timeFrame="month",setBounds(n,a,b,f),y(t,n)}),s.addEventListener("click",function(){s.classList.add("labelDistributionSelected"),o.classList.remove("labelDistributionSelected"),i.classList.remove("labelDistributionSelected"),n.timeFrame="year",setBounds(n,a,b,f),y(t,n)}),d.addEventListener("click",function(){alterBounds("shiftdown",n,a,b,f),y(t,n)}),b.addEventListener("click",function(){alterBounds("shiftup",n,a,b,f),y(t,n)})):((e=document.createElement("div")).innerText="Log in to see your time distributions",e.classList.add("notLoggedInMessage"),e.style.paddingBottom="75px",r.style.height="100%",r.style.justifyContent="center",D.style.display="none",c.style.display="none",M.style.display="none",r.appendChild(e))});export{populateLabelDistContainer,checkViewportWidth,alterBounds,setBounds,setRightArrowType,displayTimeFrame};