import{dashboardData as c,constants as e,general as u}from"../modules/dashboard-objects.js";import{timeConvert as D}from"../modules/index-objects.js";import{populateDashboardSummaryStats as r}from"./summary-stats.js";import{populateLabelDistContainer as a}from"./label-distribution.js";import{setMetricCharts as o}from"./metric-charts.js";let S=e.FOCUS_QUALITY_CONSTANT;async function populateDashboard(e,t){await n(e),await i(e,t),r(D,c.dailyArr,c),a(),o()}function s(){var t=c.dailyArr,e=[],r={},a={};let o=f(t[0].date);var s=b(u.currentDay);let i=o,n=moment(i,"YYYY-MM-DD");for(var l=moment(s,"YYYY-MM-DD");n.isSameOrBefore(l);){(a={})[o]=[];for(let e=0;e<7;e++){(r={})[i]=null;var m=y(t,i);m&&(r[i]=m),a[o].push(r[i]),i=p(i)}e.push(a),o=d(o),n=moment(i,"YYYY-MM-DD")}return e}function d(e){var e=new Date(e+"T00:00:00"),t=(e.setDate(e.getDate()+7),e.getFullYear());return t+`-${String(e.getMonth()+1).padStart(2,"0")}-`+String(e.getDate()).padStart(2,"0")}function y(e,t){return e.find(e=>e.date===t)}function p(e){var e=new Date(e+"T00:00:00"),t=(e.setDate(e.getDate()+1),e.getFullYear());return t+`-${String(e.getMonth()+1).padStart(2,"0")}-`+String(e.getDate()).padStart(2,"0")}function f(e){var e=new Date(e),t=e.getDay(),t=(e.setDate(e.getDate()-t),e.getFullYear());return t+`-${String(e.getMonth()+1).padStart(2,"0")}-`+String(e.getDate()).padStart(2,"0")}function b(e){var e=new Date(e),t=6-e.getDay(),t=(e.setDate(e.getDate()+t),e.getFullYear());return t+`-${String(e.getMonth()+1).padStart(2,"0")}-`+String(e.getDate()).padStart(2,"0")}async function i(e,t){c.sessionArr=e,c.noteData=t,c.weeklyArr=s()}async function n(e){e.forEach(e=>{let{timeZone:r,totalDeepWork:t,totalDistractions:a,perHourData:o,targetHours:s,startTime:i,deepWorkIntervals:n,breakIntervals:l,labelTimes:m}=e;var u,d,y=moment.tz(i,r).format(),p=moment(y).format("YYYY-MM-DD");c.dailySummary[p]||(c.dailySummary[p]={date:p,deepWorkTime:0,distractions:0,inDeepWork:!1,deepWorkIntervals:[],breakIntervals:[],labelTimes:{},targetHourSum:null,sessions:[]}),c.dailySummary[p].deepWorkTime+=t,c.dailySummary[p].distractions+=a,0<t&&(c.dailySummary[p].inDeepWork=!0);for(u of n)c.dailySummary[p].deepWorkIntervals.push(u);for(d of l)c.dailySummary[p].breakIntervals.push(d);if(0===Object.keys(c.dailySummary[p].labelTimes).length)c.dailySummary[p].labelTimes={...m};else for(var f in m)c.dailySummary[p].labelTimes.hasOwnProperty(f)?c.dailySummary[p].labelTimes[f]+=m[f]:c.dailySummary[p].labelTimes[f]=m[f];s&&(c.dailySummary[p].targetHourSum+=s),c.dailySummary[p].sessions.push(e),Object.entries(o).forEach(([e,t])=>{e=h(moment.tz(e,r).format());t.inDeepWork&&(c.hourlyArr[e].focusQualities.push(focusQualityCalculation(D,t.deepWorkTime,t.distractions,S)),c.hourlyArr[e].distractionsPerHour.push(calculateDistractionsPerHour(D,t.deepWorkTime,t.distractions)),c.hourlyArr[e].deepWorkTimes.push(t.deepWorkTime),c.hourlyArr[e].deepWork+=t.deepWorkTime,c.hourlyArr[e].distractions+=t.distractions)})});e=l(Object.values(c.dailySummary));c.dailyArr=e}function t(e,t){return e.forEach(e=>{var t=e.date.split("T")[0],{}=(moment(t).format("YYYY-MM-DD"),e.data)}),l(Object.values(dailySummary))}function l(e){return e.sort((e,t)=>{return new Date(e.date)-new Date(t.date)})}function h(e){var e=e.match(/T(\d{2}):/);return e?(e=e[1],parseInt(e,10)):null}function calculateDistractionsPerHour(e,t,r){r=r*e.msPerHour/t;return Math.round(10*r)/10}function focusQualityCalculation(e,t,r,a){t/=e.msPerMin;let o;return(o=0<t?1-r/t/a:0)<0?o=0:isNaN(o)&&(o=1),o=parseFloat(o.toFixed(2))}function m(e,t,r){for(var a of t)if(moment.tz(a.startTime,a.timeZone).format().split("T")[0]==e){for(var o of a.deepWorkIntervals)r[e].deepWorkIntervals.push(o);for(var s of a.breakIntervals)r[e].breakIntervals.push(s);if(0===Object.keys(r[e].labelTimes).length)r[e].labelTimes={...a.labelTimes};else for(var i in a.labelTimes)r[e].labelTimes.hasOwnProperty(i)?r[e].labelTimes[i]+=a.labelTimes[i]:r[e].labelTimes[i]=a.labelTimes[i]}return!1}export{populateDashboard,calculateDistractionsPerHour,focusQualityCalculation};