import{dashboardData as D,constants as t,general as p,flags as a}from"../modules/dashboard-objects.js";import{timeConvert as f}from"../modules/index-objects.js";import{populateDashboardSummaryStats as n}from"./summary-stats.js";import{populateLabelDistContainer as s}from"./label-distribution.js";import{setMetricCharts as o}from"./metric-charts.js";import{userTimeZone as i}from"../utility/identification.js";import{setInitialDate as l}from"./daily-sessions.js";let Y=t.FOCUS_QUALITY_CONSTANT;async function populateDashboard(t,e,r){await d(t),await u(t,e,r),n(f,D.dailyArr,D),s(),o(),a.dashboardPopulated&&l(),a.dashboardPopulated=!0}function m(e){var r=D.dailyArr,t=[],a={},n={},s=S(e);let o=T(p.currentDay);var i,l=g(e),m=l.date,l=l.string,m=(r[0]&&s?(i=moment(r[0].date,"YYYY-MM-DD"),o=m.isBefore(i)?T(l):T(r[0].date)):r[0]?o=T(r[0].date):s&&(o=T(l)),v(p.currentDay));let u=o,d=moment(u,"YYYY-MM-DD");for(var y=moment(m,"YYYY-MM-DD");d.isSameOrBefore(y);){(n={})[o]=[];for(let t=0;t<7;t++){var a={dailyData:null,noteEntryData:null},c=h(r,u),c=(c&&(a.dailyData=c),M(e,u));(0<c.notes.length||0<c.completedTasks.length)&&(a.noteEntryData=c),n[o].push(a),u=b(u)}t.push(n),o=k(o),d=moment(u,"YYYY-MM-DD")}return t}function g(n){let s=moment(p.currentDay,"YYYY-MM-DD"),o=s.format("YYYY-MM-DD");for(let a=0;a<n.length;a++){let t;t=n[a].entry.timeZone||i;let e,r=(n[a].entry.classList.includes("note")?e=n[a].entry.date:n[a].entry.classList.includes("completed-task")&&(e=n[a].entry.completionDate),moment.tz(e,t));e=r.format("YYYY-MM-DD"),(r=moment(e,"YYYY-MM-DD")).isBefore(s)&&(s=r,o=e)}return{date:s,string:o}}function S(e){for(let t=0;t<e.length;t++)if(e[t].entry.classList.includes("note")||e[t].entry.classList.includes("completed-task"))return!0;return!1}function h(t,e){return t.find(t=>t.date===e)}function M(a,n){var s,o={notes:[],completedTasks:[]};for(let r=0;r<a.length;r++){let t;t=a[r].entry.timeZone||i;let e;a[r].entry.classList.includes("note")?(e=a[r].entry.date,s=moment.tz(e,t),(e=s.format("YYYY-MM-DD"))===n&&o.notes.push(a[r].entry)):a[r].entry.classList.includes("completed-task")&&(e=a[r].entry.completionDate,s=moment.tz(e,t),(e=s.format("YYYY-MM-DD"))===n)&&o.completedTasks.push(a[r].entry)}return o}function k(t){var t=new Date(t+"T00:00:00"),e=(t.setDate(t.getDate()+7),t.getFullYear());return e+`-${String(t.getMonth()+1).padStart(2,"0")}-`+String(t.getDate()).padStart(2,"0")}function b(t){var t=new Date(t+"T00:00:00"),e=(t.setDate(t.getDate()+1),t.getFullYear());return e+`-${String(t.getMonth()+1).padStart(2,"0")}-`+String(t.getDate()).padStart(2,"0")}function T(t){var[t,e,r]=t.split("-").map(Number),t=new Date(t,e-1,r),e=t.getDay(),r=(t.setDate(t.getDate()-e),t.getFullYear());return r+`-${String(t.getMonth()+1).padStart(2,"0")}-`+String(t.getDate()).padStart(2,"0")}function v(t){var[t,e,r]=t.split("-").map(Number),t=new Date(t,e-1,r),e=6-t.getDay(),r=(t.setDate(t.getDate()+e),t.getFullYear());return r+`-${String(t.getMonth()+1).padStart(2,"0")}-`+String(t.getDate()).padStart(2,"0")}async function u(t,e,r){D.sessionArr=t,D.noteData=e,D.weeklyArr=m(r)}async function d(t){t.forEach(t=>{let{timeZone:r,totalDeepWork:e,totalDistractions:a,perHourData:n,targetHours:s,startTime:o,deepWorkIntervals:i,breakIntervals:l,labelTimes:m}=t;var u,d,y=moment.tz(o,r).format(),c=moment(y).format("YYYY-MM-DD");D.dailySummary[c]||(D.dailySummary[c]={date:c,deepWorkTime:0,distractions:0,inDeepWork:!1,deepWorkIntervals:[],breakIntervals:[],labelTimes:{},targetHourSum:null,sessions:[]}),D.dailySummary[c].deepWorkTime+=e,D.dailySummary[c].distractions+=a,0<e&&(D.dailySummary[c].inDeepWork=!0);for(u of i)D.dailySummary[c].deepWorkIntervals.push(u);for(d of l)D.dailySummary[c].breakIntervals.push(d);if(0===Object.keys(D.dailySummary[c].labelTimes).length)D.dailySummary[c].labelTimes={...m};else for(var p in m)D.dailySummary[c].labelTimes.hasOwnProperty(p)?D.dailySummary[c].labelTimes[p]+=m[p]:D.dailySummary[c].labelTimes[p]=m[p];s&&(D.dailySummary[c].targetHourSum+=s),D.dailySummary[c].sessions.push(t),Object.entries(n).forEach(([t,e])=>{t=W(moment.tz(t,r).format());e.inDeepWork&&(D.hourlyArr[t].focusQualities.push(focusQualityCalculation(f,e.deepWorkTime,e.distractions,Y)),D.hourlyArr[t].distractionsPerHour.push(calculateDistractionsPerHour(f,e.deepWorkTime,e.distractions)),D.hourlyArr[t].deepWorkTimes.push(e.deepWorkTime),D.hourlyArr[t].deepWork+=e.deepWorkTime,D.hourlyArr[t].distractions+=e.distractions)})});t=e(Object.values(D.dailySummary));D.dailyArr=t,D.dailySummary={}}function e(t){return t.sort((t,e)=>{return new Date(t.date)-new Date(e.date)})}function W(t){var t=t.match(/T(\d{2}):/);return t?(t=t[1],parseInt(t,10)):null}function calculateDistractionsPerHour(t,e,r){r=r*t.msPerHour/e;return Math.round(10*r)/10}function focusQualityCalculation(t,e,r,a){e/=t.msPerMin;let n;return(n=0<e?1-r/e/a:0)<0?n=0:isNaN(n)&&(n=1),n=parseFloat(n.toFixed(2))}export{populateDashboard,calculateDistractionsPerHour,focusQualityCalculation};