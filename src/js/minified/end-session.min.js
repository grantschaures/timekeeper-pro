import{timeConvert as c,intervals as H,startTimes as m,recoverBreakState as W,recoverPomState as _,elapsedTime as d,counters as p,flags as g,savedInterruptionsArr as y,timeAmount as f,intervalArrs as h,progressTextMod as t,lightHtmlBackground as F,darkHtmlBackground as L,times as v,perHourData as S,catIds as O,tempCounters as o,pip as s}from"../modules/index-objects.js";import{start_stop_btn as a,end_session_btn as N,total_time_display as n,productivity_chill_mode as i,progressBar as r,progressContainer as l,display as R,interruptionsSubContainer as V,interruptionsNum as Y,suggestionBreakContainer as z,suggestionBreak_label as K,suggestionBreak_min as Q,completedPomodorosContainer as q,flowAnimation as Z,chillAnimation as J,streaksCount as U,breakBackground as G,deepWorkBackground as X,commentsTextArea as u,sessionSummaryOkBtn as $,subjectiveFeedbackDropdown as e,sessionSummaryPopup as w,summaryStats as b,HC_icon_session_summary as k,commentsContainer as ee,sessionSummarySignupPromptPopup as T,popupOverlay as I,HC_icon_signup_prompt as te,signupPromptPopupBtn as oe,sessionSummaryKitty2 as C,sessionSummaryKitty1 as P,sessionSummaryKitty3 as se,blogs as ae,blog_exit as ne}from"../modules/dom-elements.js";import{soundMap as ie}from"../modules/sound-map.js";import{sessionState as D}from"../modules/state-objects.js";import{labelFlags as re,labelArrs as A,labelDict as le,notesFlags as ue,flags as ce}from"../modules/notes-objects.js";import{tempStorage as j,flags as E}from"../modules/summary-stats.js";import{flags as M,state as me}from"../modules/navigation-objects.js";import{dailyContainer as de}from"../modules/dashboard-objects.js";import{flags as pe}from"../modules/dashboard-objects.js";import{animationsFadeIn as ge,animationsFadeOut as ye,getTotalElapsed as fe,returnTotalTimeString as he,updateLabelArrs as ve,setBackground as Se,pauseAndResetAlertSounds as we,resetDisplay as be,updateProgressBar as ke,totalTimeDisplay as Te,setButtonTextAndMode as Ie,hideSuggestionBreakContainer as Ce,hidePomodorosCompletedContainer as Pe,showInterruptionsSubContainer as De,setFavicon as Ae,observer as je,pomodoroWorker as Ee,suggestionWorker as Me,flowmodoroWorker as xe,displayWorker as Be,totalDisplayWorker as He,updateDataPerHour as We,hideCat as _e}from"./index.js";import{checkInvaliDate as Fe}from"../state/check-invaliDate.js";import{addSession as Le}from"../state/add-session.js";import{closeAboutContainer as Oe,closeBlogContainer as Ne,subMainContainerTransition as Re}from"./navigation.js";import{populateDashboard as Ve}from"../dashboard/populate-dashboard.js";let Ye="/images/logo/HyperChillLogo_circular_white_border.png",ze=/iPhone|iPad|iPod|Android/i.test(navigator.userAgent);function Ke(){var e=navigator.userAgent||window.opera;return/iPad/.test(e)||1<navigator.maxTouchPoints}let Qe=Ke();function qe(e){return 1e3<e.length}function Ze(){M.sessionSummarySignupPromptPopupShowing=!0,T.style.display="flex",te.classList.add("hyperChillSlowRotate"),setTimeout(()=>{T.style.opacity=1},100)}function Je(){document.getElementById("deepWorkTime").innerHTML="",document.getElementById("focusPercentage").innerHTML="",u.value="",e.value=""}function Ue(){w.style.display="none",M.sessionSummaryPopupShowing=!1,w.style.opacity=0,multiSeriesPiePlotContainer.style.opacity=0,sessionSummaryChart.style.opacity=0,b.forEach(e=>{e.style.opacity=0}),document.body.style.overflowY="scroll"}function Ge(){I.style.display="none",I.style.opacity=1}async function Xe(e,t,o){t=t.value,o=o.value,e=e.sessionId;try{var s=await fetch("/api/data/update-session-summary",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({userComments:t,sessionRating:o,sessionId:e})});if(!s.ok)throw await s.text(),new Error("Network response was not ok");var a=await s.json();Ve(a.noteSessionData.sessions,a.noteSessionData.note,a.noteSessionData.notesEntries),de.miniChartsSeen=!1}catch(e){}}function $e(e,t){e.preventDefault();var e=t.selectionStart,o=t.value;t.value=o.slice(0,e)+"\n"+o.slice(e),t.selectionStart=t.selectionEnd=e+1,t.scrollTop=t.scrollHeight}async function et(){Re("none");var e=Intl.DateTimeFormat().resolvedOptions().timeZone,t=(ft(D,U),fe(g,d.hyperFocus,m)),o=ht(g,y,p),s=(vt(h,S),focusQualityCalculation(c,t,o,.2)),a=focusQualityCalculation(c,t,o,.5),n=t*s,i=t*a,r=(St(g,m,h),wt(h.flowTime)),l=wt(h.chillTime),u=(bt(g,re,A),pt(A,le));at(t,s,f.targetTime,j),D.loggedIn&&kt(v,e,t,s,a,n,i,o,h,y,r,l,p,f,g,u,S),tt()}function tt(){ot(),I.style.opacity=0,I.style.display="flex",setTimeout(()=>{I.style.opacity=1,setTimeout(()=>{k.style.zIndex=0},1e3)},0),w.style.display="flex",M.sessionSummaryPopupShowing=!0,ze||Qe||u.focus(),setTimeout(()=>{w.style.opacity=1,multiSeriesPiePlotContainer.style.opacity=1,sessionSummaryChart.style.opacity=1,b.forEach(e=>{e.style.opacity=1}),document.body.style.overflowY="hidden",document.dispatchEvent(new Event("triggerSessionSummaryChartAnimation"))},100)}function ot(){var e=[P,C,se];1===Math.floor(10*Math.random())+1&&g.muffinToggle&&(e[Math.floor(3*Math.random())].style.display="flex")}function st(){[P,C,se].forEach(e=>{e.style.display="none"})}function sessionReset(e){dt(A),nt(X,G),gt(F,L),document.documentElement.style.backgroundSize="400% 400%",we(ie.Bell,ie.Chime),it(g,H,W,_,m,d,p,y,h,v),Ee.postMessage("clearInterval"),Me.postMessage("clearInterval"),xe.postMessage("clearInterval"),Be.postMessage("clearInterval"),He.postMessage("clearInterval"),ye(Z),a.classList.remove("glowing-effect"),l.classList.remove("glowing-effect"),e||!D.loggedIn?setTimeout(()=>{ke(f,m,d,g,r,l),Te(m,d,n,c,g,f,t)},500):(ke(f,m,d,g,r,l),Te(m,d,n,c,g,f,t)),Ce(z,K,Q),Pe(q),De(V),setTimeout(()=>{ge(J,"flex")},100),Ae(Ye)}function at(e,t,o,s){s.deepWork=e,s.focusQuality=t,s.targetHours=o}function nt(e,t){e.style.opacity=0,t.style.opacity=0,g.pipWindowOpen&&(s.window.document.body.style.backgroundImage="",s.window.document.body.style.backgroundColor="rgba(0, 0, 0, 0)")}function it(e,t,o,s,a,n,i,r,l,u){je.disconnect(),document.title="Hyperchill.io",ut(t),B(o),B(s),B(u),mt(a),x(n),x(i),ct(e),lt(r),lt(l),rt(S)}function rt(e){for(var t in e)e.hasOwnProperty(t)&&delete e[t]}function lt(e){if(Array.isArray(e))e.splice(0,e.length);else if("object"==typeof e&&null!==e)for(var t in e)Array.isArray(e[t])&&e[t].splice(0,e[t].length)}function ut(e){for(var t in e)null!==e[t]&&(clearInterval(e[t]),e[t]=null)}function ct(e){e.hitTarget=!1,e.inHyperFocus=!1,e.autoSwitchedModes=!1,e.inRecoveryBreak=!1,e.inRecoveryPom=!1,e.modeChangeExecuted=!1,e.sentFlowmodoroNotification=!1,e.sentSuggestionMinutesNotification=!1,e.pomodoroCountIncremented=!1,e.sessionInProgress=!1}function x(e){for(var t in e)e.hasOwnProperty(t)&&(e[t]=0)}function mt(e){for(var t in e)e.hasOwnProperty(t)&&(e[t]=void 0)}function B(e){for(var t in e)e.hasOwnProperty(t)&&(e[t]=null)}function dt(e){for(var t in e)e[t]=[]}function pt(e,o){var s,a={};for(s in e){var n=e[s];let t=0;for(let e=1;e<n.length;e+=2)t+=n[e]-n[e-1];a[yt(o,s)]=t,he(t,c)}return a}function gt(e,t){g.darkThemeActivated?document.documentElement.style.backgroundImage=t:document.documentElement.style.backgroundImage=e}function yt(e,t){for(var[o,s]of Object.entries(e))if(s===t)return o;return null}async function ft(e,t){e.loggedIn||(t.innerText=1)}function ht(){return g.inHyperFocus&&y.push(p.interruptions),y.reduce((e,t)=>e+t,0)}function vt(e,t){var o=Date.now(),o=new Date(o),s=new Date(o.getFullYear(),o.getMonth(),o.getDate(),o.getHours()),o=new Date(o.getFullYear(),o.getMonth(),o.getDate(),o.getHours(),o.getMinutes(),o.getSeconds(),o.getMilliseconds());We(e,o,s,t)}function focusQualityCalculation(e,t,o,s){let a=1-o/(t/e.msPerMin)/s;return a<0?a=0:isNaN(a)&&(a=1),a}function St(e,t,o){let s;(e.inHyperFocus?(s=Date.now()-t.hyperFocus,o.flowTime):(s=Date.now()-t.chillTime,o.chillTime)).push(s)}function wt(e){return e.reduce((e,t)=>e+t,0)/e.length}function bt(e,t,o){var s=Date.now();e.inHyperFocus&&ve(s,t,o)}async function kt(e,t,o,s,a,n,i,r,l,u,c,m,d,p,g,y,f){e={startTime:e.start,endTime:e.end,timeZone:t,totalDeepWork:o,focusQualityV2:s,focusQualityV5:a,qualityAdjustedDeepWorkV2:n,qualityAdjustedDeepWorkV5:i,totalDistractions:r,distractionTimesArr:l.interruptionTime,distractionsPerIntervalArr:u,deepWorkIntervals:l.flowTime,breakIntervals:l.chillTime,avgDeepWorkInterval:c,avgBreakInterval:m,deepWorkIntervalCount:d.flowTimeIntervals,breakIntervalCount:d.chillTimeIntervals,targetHours:p.targetTime,hitTarget:g.hitTarget,pomodorosCompleted:d.pomodorosCompleted,labelTimes:y,perHourData:f};await Le(e)}function initialVisualReset(e){be(R),g.pipWindowOpen?Ie(a,i,"Start","Press 'Start'"):Ie(a,i,"Start","Press 'Start' to begin session"),_e(O,e),x(e),Y.textContent=0}document.addEventListener("stateUpdated",function(){N.addEventListener("click",async function(){if(g.sessionInProgress&&g.canEndSession){g.canEndSession=!1,v.end=Date.now(),o.catIdsArrIndex=p.catIdsArrIndex,(M.deleteAccountWindowShowing||M.accountWindowShowing||M.shortcutsWindowShowing||ce.confirmLabelDeletionWindowShowing||pe.confirmSessionDeletionPopupShowing)&&I.click();let e;D.loggedIn?(e=await Fe(v.start))?(await et(),setTimeout(()=>{initialVisualReset(o)},500)):initialVisualReset(o):(await et(),setTimeout(()=>{initialVisualReset(o),E.canSubmitSessionSummary=!0},500)),sessionReset(e)}}),document.addEventListener("keydown",function(e){"Enter"===e.key&&M.sessionSummaryPopupShowing&&$e(e,u)}),$.addEventListener("click",async function(){qe(u.value)?(alert("Please keep your comments 1000 characters or less. Thanks!"),u.focus()):E.canSubmitSessionSummary&&(st(),Ue(),"home"===me.lastSelectedMode&&(M.settingsContainerShowing?Re("flex"):M.blogContainerShowing?Ne():M.aboutContainerShowing&&Oe()),D.loggedIn?(Ge(),await Xe(j,u,e)):Ze(),Je(),B(j),E.canSubmitSessionSummary=!1,k.style.zIndex=2)}),oe.addEventListener("click",function(){window.location.href="/signup"})});export{sessionReset,focusQualityCalculation,initialVisualReset};