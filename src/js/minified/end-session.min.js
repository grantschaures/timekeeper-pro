import{timeConvert as c,intervals as H,startTimes as m,recoverBreakState as W,recoverPomState as _,elapsedTime as d,counters as p,flags as g,savedInterruptionsArr as y,timeAmount as f,intervalArrs as h,progressTextMod as t,lightHtmlBackground as F,darkHtmlBackground as L,times as v,perHourData as w,catIds as O,tempCounters as o,pip as s}from"../modules/index-objects.js";import{start_stop_btn as a,end_session_btn as N,total_time_display as n,productivity_chill_mode as i,progressBar as r,progressContainer as l,display as R,interruptionsSubContainer as V,interruptionsNum as Y,suggestionBreakContainer as z,suggestionBreak_label as K,suggestionBreak_min as Q,completedPomodorosContainer as q,flowAnimation as Z,chillAnimation as J,streaksCount as U,breakBackground as G,deepWorkBackground as X,commentsTextArea as u,sessionSummaryOkBtn as $,subjectiveFeedbackDropdown as e,sessionSummaryPopup as S,summaryStats as k,HC_icon_session_summary as T,commentsContainer as ee,sessionSummarySignupPromptPopup as b,popupOverlay as I,HC_icon_signup_prompt as te,signupPromptPopupBtn as oe,sessionSummaryKitty2 as C,sessionSummaryKitty1 as P,sessionSummaryKitty3 as se,blogs as ae,blog_exit as ne}from"../modules/dom-elements.js";import{soundMap as ie}from"../modules/sound-map.js";import{sessionState as D}from"../modules/state-objects.js";import{labelFlags as re,labelArrs as A,labelDict as le,notesFlags as ue,flags as ce}from"../modules/notes-objects.js";import{tempStorage as j,flags as M}from"../modules/summary-stats.js";import{flags as x,state as me}from"../modules/navigation-objects.js";import{animationsFadeIn as de,animationsFadeOut as pe,getTotalElapsed as ge,returnTotalTimeString as ye,updateLabelArrs as fe,setBackground as he,pauseAndResetAlertSounds as ve,resetDisplay as we,updateProgressBar as Se,totalTimeDisplay as ke,setButtonTextAndMode as Te,hideSuggestionBreakContainer as be,hidePomodorosCompletedContainer as Ie,showInterruptionsSubContainer as Ce,setFavicon as Pe,observer as De,pomodoroWorker as Ae,suggestionWorker as je,flowmodoroWorker as Me,displayWorker as xe,totalDisplayWorker as Ee,updateDataPerHour as Be,hideCat as He}from"./index.js";import{checkInvaliDate as We}from"../state/check-invaliDate.js";import{addSession as _e}from"../state/add-session.js";import{closeAboutContainer as Fe,closeBlogContainer as Le,subMainContainerTransition as Oe}from"./navigation.js";import{populateDashboard as Ne}from"../dashboard/populate-dashboard.js";let Re="/images/logo/HyperChillLogo_circular_white_border.png",Ve=/iPhone|iPad|iPod|Android/i.test(navigator.userAgent);function Ye(){var e=navigator.userAgent||window.opera;return/iPad/.test(e)||1<navigator.maxTouchPoints}let ze=Ye();function Ke(e){return 1e3<e.length}function Qe(){x.sessionSummarySignupPromptPopupShowing=!0,b.style.display="flex",te.classList.add("hyperChillSlowRotate"),setTimeout(()=>{b.style.opacity=1},100)}function qe(){document.getElementById("deepWorkTime").innerHTML="",document.getElementById("focusPercentage").innerHTML="",u.value="",e.value=""}function Ze(){S.style.display="none",x.sessionSummaryPopupShowing=!1,S.style.opacity=0,multiSeriesPiePlotContainer.style.opacity=0,sessionSummaryChart.style.opacity=0,k.forEach(e=>{e.style.opacity=0}),document.body.style.overflowY="scroll"}function Je(){I.style.display="none",I.style.opacity=1}async function Ue(e,t,o){t=t.value,o=o.value,e=e.sessionId;try{var s=await fetch("/api/data/update-session-summary",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({userComments:t,sessionRating:o,sessionId:e})});if(!s.ok)throw await s.text(),new Error("Network response was not ok");var a=await s.json();Ne(a.noteSessionData.sessions,a.noteSessionData.note)}catch(e){}}function Ge(e,t){e.preventDefault();var e=t.selectionStart,o=t.value;t.value=o.slice(0,e)+"\n"+o.slice(e),t.selectionStart=t.selectionEnd=e+1,t.scrollTop=t.scrollHeight}async function Xe(){Oe("none");var e=Intl.DateTimeFormat().resolvedOptions().timeZone,t=(gt(D,U),ge(g,d.hyperFocus,m)),o=yt(g,y,p),s=(ft(h,w),focusQualityCalculation(c,t,o,.2)),a=focusQualityCalculation(c,t,o,.5),n=t*s,i=t*a,r=(ht(g,m,h),vt(h.flowTime)),l=vt(h.chillTime),u=(wt(g,re,A),mt(A,le));ot(t,s,f.targetTime,j),D.loggedIn&&St(v,e,t,s,a,n,i,o,h,y,r,l,p,f,g,u,w),$e()}function $e(){et(),I.style.opacity=0,I.style.display="flex",setTimeout(()=>{I.style.opacity=1,setTimeout(()=>{T.style.zIndex=0},1e3)},0),S.style.display="flex",x.sessionSummaryPopupShowing=!0,Ve||ze||u.focus(),setTimeout(()=>{S.style.opacity=1,multiSeriesPiePlotContainer.style.opacity=1,sessionSummaryChart.style.opacity=1,k.forEach(e=>{e.style.opacity=1}),document.body.style.overflowY="hidden",document.dispatchEvent(new Event("triggerSessionSummaryChartAnimation"))},100)}function et(){var e=[P,C,se];1===Math.floor(10*Math.random())+1&&g.muffinToggle&&(e[Math.floor(3*Math.random())].style.display="flex")}function tt(){[P,C,se].forEach(e=>{e.style.display="none"})}function sessionReset(e){ct(A),st(X,G),dt(F,L),document.documentElement.style.backgroundSize="400% 400%",ve(ie.Bell,ie.Chime),at(g,H,W,_,m,d,p,y,h,v),Ae.postMessage("clearInterval"),je.postMessage("clearInterval"),Me.postMessage("clearInterval"),xe.postMessage("clearInterval"),Ee.postMessage("clearInterval"),pe(Z),a.classList.remove("glowing-effect"),l.classList.remove("glowing-effect"),e||!D.loggedIn?setTimeout(()=>{Se(f,m,d,g,r,l),ke(m,d,n,c,g,f,t)},500):(Se(f,m,d,g,r,l),ke(m,d,n,c,g,f,t)),be(z,K,Q),Ie(q),Ce(V),setTimeout(()=>{de(J,"flex")},100),Pe(Re)}function ot(e,t,o,s){s.deepWork=e,s.focusQuality=t,s.targetHours=o}function st(e,t){e.style.opacity=0,t.style.opacity=0,g.pipWindowOpen&&(s.window.document.body.style.backgroundImage="",s.window.document.body.style.backgroundColor="rgba(0, 0, 0, 0)")}function at(e,t,o,s,a,n,i,r,l,u){De.disconnect(),document.title="Hyperchill.io",rt(t),B(o),B(s),B(u),ut(a),E(n),E(i),lt(e),it(r),it(l),nt(w)}function nt(e){for(var t in e)e.hasOwnProperty(t)&&delete e[t]}function it(e){if(Array.isArray(e))e.splice(0,e.length);else if("object"==typeof e&&null!==e)for(var t in e)Array.isArray(e[t])&&e[t].splice(0,e[t].length)}function rt(e){for(var t in e)null!==e[t]&&(clearInterval(e[t]),e[t]=null)}function lt(e){e.hitTarget=!1,e.inHyperFocus=!1,e.autoSwitchedModes=!1,e.inRecoveryBreak=!1,e.inRecoveryPom=!1,e.modeChangeExecuted=!1,e.sentFlowmodoroNotification=!1,e.sentSuggestionMinutesNotification=!1,e.pomodoroCountIncremented=!1,e.sessionInProgress=!1}function E(e){for(var t in e)e.hasOwnProperty(t)&&(e[t]=0)}function ut(e){for(var t in e)e.hasOwnProperty(t)&&(e[t]=void 0)}function B(e){for(var t in e)e.hasOwnProperty(t)&&(e[t]=null)}function ct(e){for(var t in e)e[t]=[]}function mt(e,o){var s,a={};for(s in e){var n=e[s];let t=0;for(let e=1;e<n.length;e+=2)t+=n[e]-n[e-1];a[pt(o,s)]=t,ye(t,c)}return a}function dt(e,t){g.darkThemeActivated?document.documentElement.style.backgroundImage=t:document.documentElement.style.backgroundImage=e}function pt(e,t){for(var[o,s]of Object.entries(e))if(s===t)return o;return null}async function gt(e,t){e.loggedIn||(t.innerText=1)}function yt(){return g.inHyperFocus&&y.push(p.interruptions),y.reduce((e,t)=>e+t,0)}function ft(e,t){var o=Date.now(),o=new Date(o),s=new Date(o.getFullYear(),o.getMonth(),o.getDate(),o.getHours()),o=new Date(o.getFullYear(),o.getMonth(),o.getDate(),o.getHours(),o.getMinutes(),o.getSeconds(),o.getMilliseconds());Be(e,o,s,t)}function focusQualityCalculation(e,t,o,s){let a=1-o/(t/e.msPerMin)/s;return a<0?a=0:isNaN(a)&&(a=1),a}function ht(e,t,o){let s;(e.inHyperFocus?(s=Date.now()-t.hyperFocus,o.flowTime):(s=Date.now()-t.chillTime,o.chillTime)).push(s)}function vt(e){return e.reduce((e,t)=>e+t,0)/e.length}function wt(e,t,o){var s=Date.now();e.inHyperFocus&&fe(s,t,o)}async function St(e,t,o,s,a,n,i,r,l,u,c,m,d,p,g,y,f){e={startTime:e.start,endTime:e.end,timeZone:t,totalDeepWork:o,focusQualityV2:s,focusQualityV5:a,qualityAdjustedDeepWorkV2:n,qualityAdjustedDeepWorkV5:i,totalDistractions:r,distractionTimesArr:l.interruptionTime,distractionsPerIntervalArr:u,deepWorkIntervals:l.flowTime,breakIntervals:l.chillTime,avgDeepWorkInterval:c,avgBreakInterval:m,deepWorkIntervalCount:d.flowTimeIntervals,breakIntervalCount:d.chillTimeIntervals,targetHours:p.targetTime,hitTarget:g.hitTarget,pomodorosCompleted:d.pomodorosCompleted,labelTimes:y,perHourData:f};await _e(e)}function initialVisualReset(e){we(R),g.pipWindowOpen?Te(a,i,"Start","Press 'Start'"):Te(a,i,"Start","Press 'Start' to begin session"),He(O,e),E(e),Y.textContent=0}document.addEventListener("stateUpdated",function(){N.addEventListener("click",async function(){if(g.sessionInProgress&&g.canEndSession){g.canEndSession=!1,v.end=Date.now(),o.catIdsArrIndex=p.catIdsArrIndex,(x.deleteAccountWindowShowing||x.accountWindowShowing||x.shortcutsWindowShowing||ce.confirmLabelDeletionWindowShowing)&&I.click();let e;D.loggedIn?(e=await We(v.start))?(await Xe(),setTimeout(()=>{initialVisualReset(o)},500)):initialVisualReset(o):(await Xe(),setTimeout(()=>{initialVisualReset(o),M.canSubmitSessionSummary=!0},500)),sessionReset(e)}}),document.addEventListener("keydown",function(e){"Enter"===e.key&&x.sessionSummaryPopupShowing&&Ge(e,u)}),$.addEventListener("click",async function(){Ke(u.value)?(alert("Please keep your comments 1000 characters or less. Thanks!"),u.focus()):M.canSubmitSessionSummary&&(tt(),Ze(),"home"===me.lastSelectedMode&&(x.settingsContainerShowing?Oe("flex"):x.blogContainerShowing?Le():x.aboutContainerShowing&&Fe()),D.loggedIn?(Je(),await Ue(j,u,e)):Qe(),qe(),B(j),M.canSubmitSessionSummary=!1,T.style.zIndex=2)}),oe.addEventListener("click",function(){window.location.href="/signup"})});export{sessionReset,focusQualityCalculation,initialVisualReset};