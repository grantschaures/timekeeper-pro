import{timeConvert as c,intervals as _,startTimes as m,recoverBreakState as M,recoverPomState as F,elapsedTime as d,counters as p,flags as y,savedInterruptionsArr as g,timeAmount as f,intervalArrs as v,progressTextMod as t,lightHtmlBackground as W,darkHtmlBackground as L,times as h,perHourData as S,catIds as O,tempCounters as s}from"../modules/index-objects.js";import{start_stop_btn as o,end_session_btn as N,total_time_display as a,productivity_chill_mode as R,progressBar as n,progressContainer as r,display as V,interruptionsSubContainer as Y,interruptionsNum as z,suggestionBreakContainer as Q,suggestionBreak_label as q,suggestionBreak_min as Z,completedPomodorosContainer as J,flowAnimation as U,chillAnimation as G,streaksCount as K,breakBackground as X,deepWorkBackground as $,commentsTextArea as i,sessionSummaryOkBtn as ee,subjectiveFeedbackDropdown as e,sessionSummaryPopup as l,summaryStats as u,HC_icon_session_summary as w,commentsContainer as te,sessionSummarySignupPromptPopup as k,popupOverlay as T,HC_icon_signup_prompt as se,signupPromptPopupBtn as oe}from"../modules/dom-elements.js";import{soundMap as I}from"../modules/sound-map.js";import{sessionState as b}from"../modules/state-objects.js";import{labelFlags as ae,labelArrs as P,labelDict as ne}from"../modules/notes-objects.js";import{tempStorage as C,flags as D}from"../modules/summary-stats.js";import{flags as A}from"../modules/navigation-objects.js";import{animationsFadeIn as re,animationsFadeOut as ie,getTotalElapsed as le,returnTotalTimeString as ue,updateLabelArrs as ce,setBackground as me,pauseAndResetAlertSounds as de,resetDisplay as pe,updateProgressBar as j,totalTimeDisplay as E,setButtonTextAndMode as ye,hideSuggestionBreakContainer as ge,hidePomodorosCompletedContainer as fe,showInterruptionsSubContainer as ve,setFavicon as he,observer as Se,pomodoroWorker as we,suggestionWorker as ke,flowmodoroWorker as Te,displayWorker as Ie,totalDisplayWorker as be,updateDataPerHour as Pe,hideCat as Ce}from"./index.js";import{checkInvaliDate as De}from"../state/check-invaliDate.js";import{addSession as Ae}from"../state/add-session.js";import{subMainContainerTransition as je}from"./navigation.js";import{populateDashboard as Ee}from"../dashboard/populate-dashboard.js";let Be="/images/logo/HyperChillLogo_circular_white_border.png",He=/iPhone|iPad|iPod|Android/i.test(navigator.userAgent);function xe(){var e=navigator.userAgent||window.opera;return/iPad/.test(e)||1<navigator.maxTouchPoints}let _e=xe();function Me(e){return 1e3<e.length}function Fe(){A.sessionSummarySignupPromptPopupShowing=!0,k.style.display="flex",se.classList.add("hyperChillSlowRotate"),setTimeout(()=>{k.style.opacity=1},100)}function We(){document.getElementById("deepWorkTime").innerHTML="",document.getElementById("focusPercentage").innerHTML="",i.value="",e.value=""}function Le(){l.style.display="none",A.sessionSummaryPopupShowing=!1,l.style.opacity=0,multiSeriesPiePlotContainer.style.opacity=0,sessionSummaryChart.style.opacity=0,u.forEach(e=>{e.style.opacity=0}),document.body.style.overflowY="scroll"}function Oe(){T.style.display="none",T.style.opacity=1}async function Ne(e,t,s){t=t.value,s=s.value,e=e.sessionId;try{var o=await fetch("/api/data/update-session-summary",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({userComments:t,sessionRating:s,sessionId:e})});if(!o.ok)throw await o.text(),new Error("Network response was not ok");var a=await o.json();Ee(a.noteSessionData.sessions,a.noteSessionData.note)}catch(e){}}function Re(e,t){e.preventDefault();var e=t.selectionStart,s=t.value;t.value=s.slice(0,e)+"\n"+s.slice(e),t.selectionStart=t.selectionEnd=e+1,t.scrollTop=t.scrollHeight}async function B(){je("none");var e=Intl.DateTimeFormat().resolvedOptions().timeZone,t=(tt(b,K),le(y,d.hyperFocus,m)),s=st(y,g,p),o=(ot(v,S),focusQualityCalculation(c,t,s,.2)),a=focusQualityCalculation(c,t,s,.5),n=t*o,r=t*a,i=(at(y,m,v),nt(v.flowTime)),l=nt(v.chillTime),u=(rt(y,ae,P),Xe(P,ne));Ye(t,a,f.targetTime,C),b.loggedIn&&it(h,e,t,o,a,n,r,s,v,g,i,l,p,f,y,u,S),Ve()}function Ve(){T.style.opacity=0,T.style.display="flex",setTimeout(()=>{T.style.opacity=1,setTimeout(()=>{w.style.zIndex=0},1e3)},0),l.style.display="flex",A.sessionSummaryPopupShowing=!0,He||_e||i.focus(),setTimeout(()=>{l.style.opacity=1,multiSeriesPiePlotContainer.style.opacity=1,sessionSummaryChart.style.opacity=1,u.forEach(e=>{e.style.opacity=1}),document.body.style.overflowY="hidden",document.dispatchEvent(new Event("triggerSessionSummaryChartAnimation"))},100)}function sessionReset(e){Ke(P),ze($,X),$e(W,L),document.documentElement.style.backgroundSize="400% 400%",de(I.Bell,I.Chime),Qe(y,_,M,F,m,d,p,g,v,h),we.postMessage("clearInterval"),ke.postMessage("clearInterval"),Te.postMessage("clearInterval"),Ie.postMessage("clearInterval"),be.postMessage("clearInterval"),ie(U),o.classList.remove("glowing-effect"),r.classList.remove("glowing-effect"),e||!b.loggedIn?setTimeout(()=>{j(f,m,d,y,n,r),E(m,d,a,c,y,f,t)},500):(j(f,m,d,y,n,r),E(m,d,a,c,y,f,t)),ge(Q,q,Z),fe(J),ve(Y),setTimeout(()=>{re(G,"flex")},100),he(Be)}function Ye(e,t,s,o){o.deepWork=e,o.focusQuality=t,o.targetHours=s}function ze(e,t){e.style.opacity=0,t.style.opacity=0}function Qe(e,t,s,o,a,n,r,i,l,u){Se.disconnect(),document.title="Hyperchill.io",Je(t),x(s),x(o),x(u),Ge(a),H(n),H(r),Ue(e),Ze(i),Ze(l),qe(S)}function qe(e){for(var t in e)e.hasOwnProperty(t)&&delete e[t]}function Ze(e){if(Array.isArray(e))e.splice(0,e.length);else if("object"==typeof e&&null!==e)for(var t in e)Array.isArray(e[t])&&e[t].splice(0,e[t].length)}function Je(e){for(var t in e)null!==e[t]&&(clearInterval(e[t]),e[t]=null)}function Ue(e){e.hitTarget=!1,e.inHyperFocus=!1,e.autoSwitchedModes=!1,e.inRecoveryBreak=!1,e.inRecoveryPom=!1,e.modeChangeExecuted=!1,e.sentFlowmodoroNotification=!1,e.sentSuggestionMinutesNotification=!1,e.pomodoroCountIncremented=!1,e.sessionInProgress=!1}function H(e){for(var t in e)e.hasOwnProperty(t)&&(e[t]=0)}function Ge(e){for(var t in e)e.hasOwnProperty(t)&&(e[t]=void 0)}function x(e){for(var t in e)e.hasOwnProperty(t)&&(e[t]=null)}function Ke(e){for(var t in e)e[t]=[]}function Xe(e,s){var o,a={};for(o in e){var n=e[o];let t=0;for(let e=1;e<n.length;e+=2)t+=n[e]-n[e-1];a[et(s,o)]=t,ue(t,c)}return a}function $e(e,t){y.darkThemeActivated?document.documentElement.style.backgroundImage=t:document.documentElement.style.backgroundImage=e}function et(e,t){for(var[s,o]of Object.entries(e))if(o===t)return s;return null}async function tt(e,t){e.loggedIn||(t.innerText=1)}function st(){return y.inHyperFocus&&g.push(p.interruptions),g.reduce((e,t)=>e+t,0)}function ot(e,t){var s=Date.now(),s=new Date(s),o=new Date(s.getFullYear(),s.getMonth(),s.getDate(),s.getHours()),s=new Date(s.getFullYear(),s.getMonth(),s.getDate(),s.getHours(),s.getMinutes(),s.getSeconds(),s.getMilliseconds());Pe(e,s,o,t)}function focusQualityCalculation(e,t,s,o){let a=1-s/(t/e.msPerMin)/o;return a<0?a=0:isNaN(a)&&(a=1),a}function at(e,t,s){let o;(e.inHyperFocus?(o=Date.now()-t.hyperFocus,s.flowTime):(o=Date.now()-t.chillTime,s.chillTime)).push(o)}function nt(e){return e.reduce((e,t)=>e+t,0)/e.length}function rt(e,t,s){var o=Date.now();e.inHyperFocus&&ce(o,t,s)}async function it(e,t,s,o,a,n,r,i,l,u,c,m,d,p,y,g,f){e={startTime:e.start,endTime:e.end,timeZone:t,totalDeepWork:s,focusQualityV2:o,focusQualityV5:a,qualityAdjustedDeepWorkV2:n,qualityAdjustedDeepWorkV5:r,totalDistractions:i,distractionTimesArr:l.interruptionTime,distractionsPerIntervalArr:u,deepWorkIntervals:l.flowTime,breakIntervals:l.chillTime,avgDeepWorkInterval:c,avgBreakInterval:m,deepWorkIntervalCount:d.flowTimeIntervals,breakIntervalCount:d.chillTimeIntervals,targetHours:p.targetTime,hitTarget:y.hitTarget,pomodorosCompleted:d.pomodorosCompleted,labelTimes:g,perHourData:f};await Ae(e)}function initialVisualReset(e){pe(V),ye(o,R,"Start","Press 'Start' to begin session"),Ce(O,e),H(e),z.textContent=0}document.addEventListener("stateUpdated",function(){N.addEventListener("click",async function(){if(y.sessionInProgress&&y.canEndSession){y.canEndSession=!1,h.end=Date.now(),s.catIdsArrIndex=p.catIdsArrIndex;let e;b.loggedIn?(e=await De(h.start))?(await B(),setTimeout(()=>{initialVisualReset(s)},500)):initialVisualReset(s):(await B(),setTimeout(()=>{initialVisualReset(s),D.canSubmitSessionSummary=!0},500)),sessionReset(e)}}),document.addEventListener("keydown",function(e){"Enter"===e.key&&A.sessionSummaryPopupShowing&&Re(e,i)}),ee.addEventListener("click",async function(){Me(i.value)?(alert("Please keep your comments 1000 characters or less. Thanks!"),i.focus()):D.canSubmitSessionSummary&&(Le(),b.loggedIn?(Oe(),await Ne(C,i,e)):Fe(),We(),x(C),D.canSubmitSessionSummary=!1,w.style.zIndex=2)}),oe.addEventListener("click",function(){window.location.href="/signup"})});export{sessionReset,focusQualityCalculation,initialVisualReset};