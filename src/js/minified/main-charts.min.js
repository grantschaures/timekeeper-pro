import{directionIndicators as P,summaryAvgAdjustedDeepWorkDown as Q,summaryAvgAdjustedDeepWorkTime as j,summaryAvgAdjustedDeepWorkUp as $,summaryAvgBreakInterval as H,summaryAvgBreakIntervalDown as L,summaryAvgBreakIntervalUp as J,summaryAvgDeepWorkDown as Z,summaryAvgDeepWorkInterval as E,summaryAvgDeepWorkIntervalDown as U,summaryAvgDeepWorkIntervalUp as z,summaryAvgDeepWorkTime as R,summaryAvgDeepWorkUp as q,summaryDeepWorkTime as V,summaryDeepWorkTimeUp as t,summaryFocusQuality as _,summaryFocusQualityDown as G,summaryFocusQualityUp as K}from"../modules/dashboard-elements.js";import{charts as o,mainChartContainer as m,dashboardData as n,flags as k,constants as X,general as ee}from"../modules/dashboard-objects.js";import{timeConvert as l}from"../modules/index-objects.js";import{updateDailyContainer as te}from"../dashboard/daily-sessions.js";let i=[],w=[],D=[],a=[],s=[],u=[],d=[],M=[],p=[],c=[],h=X.FOCUS_QUALITY_CONSTANT,g={deepWorkTime:null,avgDeepWorkTime:null,focusQuality:null,adjustedDeepWorkTime:null,deepWorkInterval:null,breakInterval:null},y={deepWorkTime:null,avgDeepWorkTime:null,focusQuality:null,adjustedDeepWorkTime:null,deepWorkInterval:null,breakInterval:null},f={deepWork:0,avgInterval:0},Y=[],v=["Sun","Mon","Tue","Wed","Thur","Fri","Sat"],b=["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"],I={week:v,month:[],year:b};function r(e){for(var t in e)e.hasOwnProperty(t)&&(e[t]=null)}async function re(){var e=F(),t=T(),r=C(),a=x();await A(g,e,t,r[0],r[1],a[0],a[1]),le(),ae()}async function ae(){W("shiftdown"),await be(),await ke(n,m,i,u,d,f);var e=F(),t=T(),r=C(),a=x();await A(y,e,t,r[0],r[1],a[0],a[1]),ne(),W("shiftup")}function ne(){oe("deepWorkTime"),e("avgDeepWorkTime",q,Z),e("adjustedDeepWorkTime",$,Q),e("focusQuality",K,G),e("deepWorkInterval",z,U),e("breakInterval",J,L)}function oe(e){g[e]>y[e]&&(t.style.display="flex",setTimeout(()=>{t.style.opacity="1"},0))}function e(e,t,r){null!==y[e]&&null!==g[e]?g[e]>y[e]?(t.style.display="flex",setTimeout(()=>{t.style.opacity="1"},0)):g[e]<y[e]&&(r.style.display="flex",setTimeout(()=>{r.style.opacity="1"},0)):(t.style.display="none",r.style.display="none",setTimeout(()=>{t.style.opacity="0",r.style.opacity="0"},0))}function le(){me(g.deepWorkTime),de(g.avgDeepWorkTime),ue(g.focusQuality),se(g.focusQuality,g.adjustedDeepWorkTime),ie(g.deepWorkInterval,g.breakInterval)}function ie(e,t){let r;r=null!==e?Math.round(e)+"m":"N/A";let a;a=null!==t?Math.round(t)+"m":"N/A",E.innerHTML=`<b>${r}</b>`,H.innerHTML=`<b>${a}</b>`}function se(e,t){let r;r=null!==e&&null!==t?(e=Math.floor(t))+`h ${Math.round(60*(t-e))}m`:"N/A",j.innerHTML=`<b>${r}</b>`}function ue(e){let t;t=null!==e?Math.floor(100*e)+"%":"N/A",_.innerHTML=`<b>${t}</b>`}function de(e){let t;var r;t=null!==e?(r=Math.floor(e))+`h ${Math.round(60*(e-r))}m`:"N/A",R.innerHTML=`<b>${t}</b>`}function me(e){var t=Math.floor(e),e=Math.round(60*(e-t));V.innerHTML=`<b>${` ${t}h ${e}m`}</b>`}function W(e){"shiftup"===e?(m.lowerBound=moment(m.lowerBound,"YYYY-MM-DD").add(1,m.timeFrame).format("YYYY-MM-DD"),"month"===m.timeFrame?m.upperBound=moment(m.lowerBound,"YYYY-MM-DD").endOf("month").format("YYYY-MM-DD"):m.upperBound=moment(m.upperBound,"YYYY-MM-DD").add(1,m.timeFrame).format("YYYY-MM-DD")):"shiftdown"===e&&(m.lowerBound=moment(m.lowerBound,"YYYY-MM-DD").subtract(1,m.timeFrame).format("YYYY-MM-DD"),"month"===m.timeFrame?m.upperBound=moment(m.lowerBound,"YYYY-MM-DD").endOf("month").format("YYYY-MM-DD"):m.upperBound=moment(m.upperBound,"YYYY-MM-DD").subtract(1,m.timeFrame).format("YYYY-MM-DD"))}async function A(e,t,r,a,n,o,l){e.deepWorkTime=t,e.avgDeepWorkTime=r,e.focusQuality=a,e.adjustedDeepWorkTime=n,e.deepWorkInterval=o,e.breakInterval=l}function x(){let e=null;var t;0<a.length&&(t=a.reduce((e,t)=>e+t,0)/a.length,e=t/l.msPerMin);let r=null;return 0<s.length&&(t=s.reduce((e,t)=>e+t,0)/s.length,r=t/l.msPerMin),[e,r]}function C(){let e=null,t=null;var r,a;return 0<w.length&&(r=w.reduce((e,t)=>e+t,0)/w.length,a=D.reduce((e,t)=>e+t,0)/D.length,(t=1-a/(60*r)/h)<0?t=0:isNaN(t)&&(t=1),e=r*t),[t,e]}function T(){let e=null;return e=0<w.length?w.reduce((e,t)=>e+t,0)/w.length:e}function F(){return w.reduce((e,t)=>e+t,0)}function pe(e){var t=Math.floor(e),e=Math.floor(60*(e-t));return(t%12==0?12:t%12)+`:${e<10?"0"+e:e} `+(t<12||24===t?"am":"pm")}async function ce(){var t=n.sessionArr;for(let e=0;e<t.length;e++){var r=moment.tz(t[e].startTime,t[e].timeZone).format(),a=moment.tz(t[e].endTime,t[e].timeZone).format();moment(a,"YYYY-MM-DD").isSameOrAfter(moment(m.lowerBound,"YYYY-MM-DD"))&&moment(r,"YYYY-MM-DD").isSameOrBefore(moment(m.upperBound,"YYYY-MM-DD"))&&he(r,a,ye(r,t[e].deepWorkIntervals,t[e].breakIntervals))}}function he(t,r,a){for(let e=0;e<a.length-1;e++){var n=ge(t,m.timeFrame),o=ge(r,m.timeFrame),l=e%2==0?p:c,i=moment(t,"YYYY-MM-DD").isBefore(moment(m.lowerBound,"YYYY-MM-DD")),s=moment(r,"YYYY-MM-DD").isAfter(moment(m.upperBound,"YYYY-MM-DD")),u=a[e],d=a[e+1];i?24<d&&(u<24?l.push({x:o,y:[0,d-24]}):l.push({x:o,y:[u-24,d-24]})):s?u<24&&(24<d?l.push({x:n,y:[u,24]}):l.push({x:n,y:[u,d]})):24<u&&24<d?l.push({x:o,y:[u-24,d-24]}):24<d?(l.push({x:n,y:[u,24]}),l.push({x:o,y:[0,d-24]})):l.push({x:n,y:[u,d]})}}function ge(e,t){e=(e=e.split("T")[0]).split("-"),e=new Date(e[0],e[1]-1,e[2]);return"week"===t?["Sun","Mon","Tue","Wed","Thur","Fri","Sat"][e.getDay()]:"month"===t?e.getDate().toString():"year"===t?["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"][e.getMonth()]:null}function ye(e,t,r){var a=ve(t,r),n=[];let o=fe(e);n.push(o);for(let e=0;e<a.length;e++)o+=a[e]/l.msPerHour,n.push(o);return n}function fe(e){e=moment.parseZone(e);return e.hours()+e.minutes()/60+e.seconds()/3600}function ve(t,r){var a=[];for(let e=0;e<t.length;e++)a.push(t[e]),r[e]&&a.push(r[e]);return a}async function be(){i=[],u=[],d=[],M=[],p=[],c=[],Object.keys(f).forEach(e=>{f[e]=0}),Y=[],I.month=[],w=[],D=[],a=[],s=[],P.forEach(e=>{e.style.display="none",e.style.opacity="0"}),k.populated365Arrs=!1}async function ke(e,r,a,n,o,l){var i=[0,0,0,0,0,0,0,0,0,0,0,0],s=[0,0,0,0,0,0,0,0,0,0,0,0],u=[[],[],[],[],[],[],[],[],[],[],[],[]],t=e.dailyArr;for(let e=0;e<t.length;e++){var d=t[e].date;if(moment(d,"YYYY-MM-DD").isSameOrAfter(moment(r.lowerBound,"YYYY-MM-DD"))&&moment(d,"YYYY-MM-DD").isSameOrBefore(moment(r.upperBound,"YYYY-MM-DD"))){var m=B(t[e])[0],p=B(t[e])[1],c=Se(t[e]),h=Ce(d);if(w.push(m),D.push(t[e].distractions),"week"===r.timeFrame){for(var g=We(d);a.length<g;)a.push(0),n.push(0),o.push(0);Ye(h,g)}else if("month"===r.timeFrame){for(var y=Ie(d);a.length<y;)a.push(0),n.push(0),o.push(0);Ye(h,y)}else{h=Me(d);i[h]+=t[e].deepWorkTime,s[h]+=t[e].distractions,k.avgBreakIntervalToggle?u[h].push(...t[e].breakIntervals):u[h].push(...t[e].deepWorkIntervals)}"year"!==r.timeFrame&&(a.push(m),n.push(Math.floor(100*p)),o.push(c))}}if("month"===r.timeFrame&&(e=xe(r.lowerBound),I.month=Ae(e),M=we(r.lowerBound,I.month)),k.populated365Arrs=!0,"year"===r.timeFrame){let t=!1;for(let e=l.avgInterval=0;e<12;e++){var f,v={deepWorkTime:i[e],distractions:s[e],deepWorkIntervals:u[e],breakIntervals:u[e]},b=(0!==i[e]?(b=B(v)[0],f=B(v)[1],v=Se(v),a.push(b),n.push(Math.floor(100*f)),o.push(v),t=!0):(a.push(0),n.push(0),o.push(0)),De(r.lowerBound,e));Y.push(b)}t||(a.length=0,n.length=0,o.length=0)}l.deepWork=Te(l.deepWork),l.avgInterval=Fe(l.avgInterval)}function we(e,t){let[r,a]=e.split("-").map(Number),n=[];return t.forEach((e,t)=>{0===new Date(r,a-1,Number(e)).getDay()&&n.push(t)}),n}function De(e,t){e=e.split("-")[0];return["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"][t]+", "+e}function Me(e){e=e.split("-")[1];return parseInt(e,10)-1}function Ye(e,t){if(Y.length!==t)for(;Y.length<t;)Y.push("no data");Y.push(e)}function Ie(e){var[e,t,r]=e.split("-").map(Number);return new Date(e,t-1,r).getDate()-1}function We(e){var[e,t,r]=e.split("-").map(Number);return new Date(e,t-1,r).getDay()}function Ae(t){var r=[];for(let e=1;e<=t;e++)r.push(String(e));return r}function xe(e){var[e,t]=e.split("-").map(Number);return new Date(e,t,0).getDate()}function Ce(e){var[,t,r]=e.split("-"),t=["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"][parseInt(t)-1];r=parseInt(r)+function(e){if(3<e&&e<21)return"th";switch(e%10){case 1:return"st";case 2:return"nd";case 3:return"rd";default:return"th"}}(parseInt(r)),e=We(e);return I.week[e]+`, ${t} `+r}function Te(e){let t=Math.ceil(e);return Be(t)&&2<t&&t++,t}function Fe(e){return 2*Math.ceil(e/2)}function Be(t){if(t<=1)return!1;if(!(t<=3)){if(t%2==0||t%3==0)return!1;for(let e=5;e*e<=t;e+=6)if(t%e==0||t%(e+2)==0)return!1}return!0}function Se(e){k.populated365Arrs||(a.push(...e.deepWorkIntervals),s.push(...e.breakIntervals));let t;t=k.avgBreakIntervalToggle?e.breakIntervals.reduce((e,t)=>e+t,0)/e.breakIntervals.length:e.deepWorkIntervals.reduce((e,t)=>e+t,0)/e.deepWorkIntervals.length;e=Math.round(t/l.msPerMin);return e>f.avgInterval&&(f.avgInterval=e),e}function B(e){let t=e.deepWorkTime/l.msPerHour;var r=60*t;t>f.deepWork&&(f.deepWork=t);let a=1-e.distractions/r/h;return a<0?a=0:isNaN(a)&&(a=1),k.adjustedDeepWorkToggle&&(t*=a),[t,a]}function S(e){e=Oe(m.lowerBound,m.upperBound)[e];te(e)}function Oe(e,t){for(var r=new Date(e),a=new Date(t),n=[];r<=a;)n.push(r.toISOString().split("T")[0]),r.setDate(r.getDate()+1);return n}function Ne(){let e;e="week"===m.timeFrame?I.week:"month"===m.timeFrame?I.month:I.year;let t;t=k.adjustedDeepWorkToggle?"#0cce63":"rgba(63, 210, 68, 1)",f.deepWork<6&&(f.deepWork=6),0===i.length&&(f.deepWork=0);var r=document.getElementById("deepWorkChart").getContext("2d"),a={type:"bar",data:{labels:e,datasets:[{label:"Deep Work Hours",data:i,backgroundColor:t,borderColor:"rgb(255, 255, 255)",borderRadius:25,borderSkipped:!1,barPercentage:1,categoryPercentage:.5}]},options:{onClick:function(e,t){var r;"year"!==m.timeFrame&&0<t.length&&(r=t[0].index,t[0].datasetIndex,S(r))},onHover:function(e,t){var r=this.canvas;t.length&&"year"!==m.timeFrame?r.style.cursor="pointer":r.style.cursor="default"},scales:{y:{beginAtZero:!0,max:f.deepWork,title:{display:!0,text:"Deep Work Hours",color:"white"},ticks:{color:"white",stepSize:1},grid:{display:!0,color:"rgba(255, 255, 255, 0.15)",lineWidth:1,drawBorder:!0,drawOnChartArea:!0,drawTicks:!1}},x:{title:{display:!1},ticks:{color:"white"}}},plugins:{legend:{display:!1},tooltip:{enabled:!0,backgroundColor:"rgb(0, 0, 0)",titleColor:"white",bodyColor:"white",borderColor:"white",borderWidth:2,callbacks:{title:function(e){e=e[0].dataIndex;return""+Y[e]},label:function(e){var t=Math.floor(e.raw);return` ${t}h ${Math.round(60*(e.raw-t))}m`}}}},animations:{x:{duration:0},y:{duration:k.quickerChartAnimations?500:1e3,easing:"easeOutQuint"}}},plugins:[N,O]};o.deepWork&&(o.deepWork.destroy(),o.deepWork=null),o.deepWork=new Chart(r,a)}function Pe(){let e;if("week"===m.timeFrame)e=I.week;else if("month"===m.timeFrame){e=I.month;for(let e=0;e<u.length;e++)"no data"===Y[e]&&(u[e]=null)}else e=I.year;let t="bar";"month"===m.timeFrame&&(t="line");let r={beginAtZero:!0,suggestedMax:100,title:{display:!0,text:"Focus Quality %",color:"white"},ticks:{color:"white"},grid:{display:!0,color:"rgba(255, 255, 255, 0.15)",lineWidth:1,drawBorder:!0,drawOnChartArea:!0,drawTicks:!1}};0===u.length&&(r={beginAtZero:!0,max:0,title:{display:!0,text:"Focus Quality %",color:"white"},ticks:{color:"white"},grid:{display:!0,color:"rgba(255, 255, 255, 0.15)",lineWidth:1,drawBorder:!0,drawOnChartArea:!0,drawTicks:!1}});var a=document.getElementById("focusQualityChart").getContext("2d"),n={type:t,data:{labels:e,datasets:[{label:"Focus Quality %",data:u,backgroundColor:"rgb(162, 0, 212)",borderColor:"rgb(255, 255, 255)",borderRadius:25,borderSkipped:!1,barPercentage:1,categoryPercentage:.5,pointRadius:5,pointHoverRadius:8,spanGaps:!0,tension:.4}]},options:{onClick:function(e,t){var r;"year"!==m.timeFrame&&0<t.length&&(r=t[0].index,t[0].datasetIndex,S(r))},onHover:function(e,t){var r=this.canvas;t.length&&"year"!==m.timeFrame?r.style.cursor="pointer":r.style.cursor="default"},scales:{y:r,x:{title:{display:!1},ticks:{color:"white"}}},plugins:{legend:{display:!1},tooltip:{enabled:!0,backgroundColor:"rgb(0, 0, 0)",titleColor:"white",bodyColor:"white",borderColor:"white",borderWidth:2,callbacks:{title:function(e){e=e[0].dataIndex;return""+Y[e]},label:function(e){var t=e.dataIndex;return"no data"===Y[t]?null:` ${e.raw}%`}}}},animations:{x:{duration:0},y:{duration:k.quickerChartAnimations?500:1e3,easing:"easeOutQuint"}}},plugins:[N,O]};o.focusQuality&&(o.focusQuality.destroy(),o.focusQuality=null),o.focusQuality=new Chart(a,n)}function Qe(){let e;e="week"===m.timeFrame?I.week:"month"===m.timeFrame?I.month:I.year;let t;t=k.avgBreakIntervalToggle?"rgba(59, 143, 227, 1)":"rgba(83, 230, 88, 1)";var r={beginAtZero:!0,max:f.avgInterval,title:{display:!0,text:"Interval Length (Min)",color:"white"},ticks:{color:"white",stepSize:10},grid:{display:!0,color:"rgba(255, 255, 255, 0.15)",lineWidth:1,drawBorder:!0,drawOnChartArea:!0,drawTicks:!1}};let a={beginAtZero:!0,suggestedMax:f.avgInterval,title:{display:!0,text:"Interval Length (Min)",color:"white"},ticks:{color:"white",stepSize:10},grid:{display:!0,color:"rgba(255, 255, 255, 0.15)",lineWidth:1,drawBorder:!0,drawOnChartArea:!0,drawTicks:!1}};f.avgInterval<60&&(f.avgInterval=60,r.max=f.avgInterval,a=r),0===d.length&&(a={beginAtZero:!0,max:0,title:{display:!0,text:"Interval Length (Min)",color:"white"},ticks:{color:"white",stepSize:10},grid:{display:!0,color:"rgba(255, 255, 255, 0.15)",lineWidth:1,drawBorder:!0,drawOnChartArea:!0,drawTicks:!1}});var r=document.getElementById("avgIntervalChart").getContext("2d"),n={type:"bar",data:{labels:e,datasets:[{label:"Interval Length (Min)",data:d,backgroundColor:t,borderColor:"rgb(255, 255, 255)",borderRadius:25,borderSkipped:!1,barPercentage:1,categoryPercentage:.5}]},options:{onClick:function(e,t){var r;"year"!==m.timeFrame&&0<t.length&&(r=t[0].index,t[0].datasetIndex,S(r))},onHover:function(e,t){var r=this.canvas;t.length&&"year"!==m.timeFrame?r.style.cursor="pointer":r.style.cursor="default"},scales:{y:a,x:{title:{display:!1},ticks:{color:"white"}}},plugins:{legend:{display:!1},tooltip:{enabled:!0,backgroundColor:"rgb(0, 0, 0)",titleColor:"white",bodyColor:"white",borderColor:"white",borderWidth:2,callbacks:{title:function(e){e=e[0].dataIndex;return""+Y[e]},label:function(e){return` ${e.raw}m`}}}},animations:{x:{duration:0},y:{duration:k.quickerChartAnimations?500:1e3,easing:"easeOutQuint"}}},plugins:[N,O]};o.avgInterval&&(o.avgInterval.destroy(),o.avgInterval=null),o.avgInterval=new Chart(r,n)}function je(){let e;var t={labels:e="week"===m.timeFrame?I.week:"month"===m.timeFrame?I.month:I.year,datasets:[{label:"Deep Work",data:p,backgroundColor:"rgba(63, 210, 68, 1)",borderColor:"rgb(255, 255, 255)",borderRadius:0,borderSkipped:!1},{label:"Break",data:c,backgroundColor:"rgba(59, 143, 227, 1)",borderColor:"rgb(255, 255, 255)",borderRadius:0,borderSkipped:!1}]};let r=[],a=(r="week"===m.timeFrame?v:"month"===m.timeFrame?I.month:b,24);0===p.length&&(a=0);var n=document.getElementById("sessionIntervalsChart").getContext("2d"),t={type:"bar",data:t,options:{scales:{y:{beginAtZero:!0,min:0,max:a,reverse:!0,title:{display:!1,text:"Day",color:"white"},ticks:{stepSize:3,color:"white",callback:function(e){return 0===e||24===e?"12 AM":3===e?"3 AM":6===e?"6 AM":9===e?"9 AM":12===e?"12 PM":15===e?"3 PM":18===e?"6 PM":21===e?"9 PM":""}},grid:{display:!0,color:"rgba(255, 255, 255, 0.15)",lineWidth:1,drawBorder:!0,drawOnChartArea:!0,drawTicks:!1}},x:{stacked:!0,title:{display:!1},ticks:{color:"white"}}},plugins:{legend:{display:!0},tooltip:{enabled:!0,backgroundColor:"rgb(0, 0, 0)",titleColor:"white",bodyColor:"white",borderColor:"white",borderWidth:2,callbacks:{title:function(e){e=e.map(e=>e.label||e.xLabel).join(", "),e=r.indexOf(e);let t=Y[e];return""+(t="no data"===t?"data from session started previous day":t)},label:function(e){return` ${pe(e.raw.y[0])} - `+pe(e.raw.y[1])}}}},animations:!1},plugins:[N,O]};o.sessionIntervals&&(o.sessionIntervals.destroy(),o.sessionIntervals=null),o.sessionIntervals=new Chart(n,t)}document.addEventListener("displayMainCharts",async function(){r(g),r(y),await be(),await ke(n,m,i,u,d,f);var e=ee.chartTransition;"summary"===e&&re(),"all"!==e&&"main-adjusted"!==e||Ne(),"all"===e&&Pe(),"all"!==e&&"main-break"!==e||Qe(),k.quickerChartAnimations=!0,await ce(),"all"===e&&je()});let O={id:"dottedLinePlugin",afterDraw:function(e){if("month"===m.timeFrame&&0<i.length){var t=e.ctx,r=e.scales.x,a=e.scales.y;for(let e=0;e<M.length;e++){var n=M[e],n=(r.getPixelForValue(n-1)+r.getPixelForValue(n))/2;t.save(),t.setLineDash([5,5]),t.strokeStyle="rgba(255, 255, 255, 0.15)",t.lineWidth=2,t.beginPath(),t.moveTo(n,a.top),t.lineTo(n,a.bottom),t.stroke(),t.restore()}}}},N={id:"noDataPlugin",afterDraw:function(e){var t,r;0!==e.data.datasets[0].data.length&&!e.data.datasets[0].data.every(e=>null===e)||(t=e.ctx,r=e.width,e=e.height,t.save(),t.textAlign="center",t.textBaseline="middle",t.font="48px settingsHeaderFont",t.fillStyle="gray",t.fillText("No Data 😩",r/2,e/2-20),t.restore())}};