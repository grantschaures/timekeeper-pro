import{directionIndicators as N,summaryAvgAdjustedDeepWorkDown as Q,summaryAvgAdjustedDeepWorkTime as j,summaryAvgAdjustedDeepWorkUp as $,summaryAvgBreakInterval as L,summaryAvgBreakIntervalDown as H,summaryAvgBreakIntervalUp as J,summaryAvgDeepWorkDown as Z,summaryAvgDeepWorkInterval as E,summaryAvgDeepWorkIntervalDown as U,summaryAvgDeepWorkIntervalUp as z,summaryAvgDeepWorkTime as R,summaryAvgDeepWorkUp as q,summaryDeepWorkTime as V,summaryDeepWorkTimeUp as t,summaryFocusQuality as _,summaryFocusQualityDown as G,summaryFocusQualityUp as K}from"../modules/dashboard-elements.js";import{charts as o,mainChartContainer as m,dashboardData as n,flags as k,constants as X,general as ee}from"../modules/dashboard-objects.js";import{timeConvert as l}from"../modules/index-objects.js";let i=[],w=[],M=[],a=[],s=[],u=[],d=[],D=[],p=[],c=[],h=X.FOCUS_QUALITY_CONSTANT,g={deepWorkTime:null,avgDeepWorkTime:null,focusQuality:null,adjustedDeepWorkTime:null,deepWorkInterval:null,breakInterval:null},y={deepWorkTime:null,avgDeepWorkTime:null,focusQuality:null,adjustedDeepWorkTime:null,deepWorkInterval:null,breakInterval:null},v={deepWork:0,avgInterval:0},Y=[],b=["Sun","Mon","Tue","Wed","Thur","Fri","Sat"],f=["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"],W={week:b,month:[],year:f};function r(e){for(var t in e)e.hasOwnProperty(t)&&(e[t]=null)}async function te(){var e=B(),t=x(),r=C(),a=T();await A(g,e,t,r[0],r[1],a[0],a[1]),oe(),re()}async function re(){I("shiftdown"),await ve(),await be(n,m,i,u,d,v);var e=B(),t=x(),r=C(),a=T();await A(y,e,t,r[0],r[1],a[0],a[1]),ae(),I("shiftup")}function ae(){ne("deepWorkTime"),e("avgDeepWorkTime",q,Z),e("adjustedDeepWorkTime",$,Q),e("focusQuality",K,G),e("deepWorkInterval",z,U),e("breakInterval",J,H)}function ne(e){g[e]>y[e]&&(t.style.display="flex",setTimeout(()=>{t.style.opacity="1"},0))}function e(e,t,r){null!==y[e]&&null!==g[e]?g[e]>y[e]?(t.style.display="flex",setTimeout(()=>{t.style.opacity="1"},0)):g[e]<y[e]&&(r.style.display="flex",setTimeout(()=>{r.style.opacity="1"},0)):(t.style.display="none",r.style.display="none",setTimeout(()=>{t.style.opacity="0",r.style.opacity="0"},0))}function oe(){de(g.deepWorkTime),ue(g.avgDeepWorkTime),se(g.focusQuality),ie(g.focusQuality,g.adjustedDeepWorkTime),le(g.deepWorkInterval,g.breakInterval)}function le(e,t){let r;r=null!==e?Math.round(e)+"m":"N/A";let a;a=null!==t?Math.round(t)+"m":"N/A",E.innerHTML=`<b>${r}</b>`,L.innerHTML=`<b>${a}</b>`}function ie(e,t){let r;r=null!==e&&null!==t?(e=Math.floor(t))+`h ${Math.round(60*(t-e))}m`:"N/A",j.innerHTML=`<b>${r}</b>`}function se(e){let t;t=null!==e?Math.floor(100*e)+"%":"N/A",_.innerHTML=`<b>${t}</b>`}function ue(e){let t;var r;t=null!==e?(r=Math.floor(e))+`h ${Math.round(60*(e-r))}m`:"N/A",R.innerHTML=`<b>${t}</b>`}function de(e){var t=Math.floor(e),e=Math.round(60*(e-t));V.innerHTML=`<b>${` ${t}h ${e}m`}</b>`}function I(e){"shiftup"===e?(m.lowerBound=moment(m.lowerBound,"YYYY-MM-DD").add(1,m.timeFrame).format("YYYY-MM-DD"),m.upperBound=moment(m.upperBound,"YYYY-MM-DD").add(1,m.timeFrame).format("YYYY-MM-DD")):"shiftdown"===e&&(m.lowerBound=moment(m.lowerBound,"YYYY-MM-DD").subtract(1,m.timeFrame).format("YYYY-MM-DD"),m.upperBound=moment(m.upperBound,"YYYY-MM-DD").subtract(1,m.timeFrame).format("YYYY-MM-DD"))}async function A(e,t,r,a,n,o,l){e.deepWorkTime=t,e.avgDeepWorkTime=r,e.focusQuality=a,e.adjustedDeepWorkTime=n,e.deepWorkInterval=o,e.breakInterval=l}function T(){let e=null;var t;0<a.length&&(t=a.reduce((e,t)=>e+t,0)/a.length,e=t/l.msPerMin);let r=null;return 0<s.length&&(t=s.reduce((e,t)=>e+t,0)/s.length,r=t/l.msPerMin),[e,r]}function C(){let e=null,t=null;var r,a;return 0<w.length&&(r=w.reduce((e,t)=>e+t,0)/w.length,a=M.reduce((e,t)=>e+t,0)/M.length,(t=1-a/(60*r)/h)<0?t=0:isNaN(t)&&(t=1),e=r*t),[t,e]}function x(){let e=null;return e=0<w.length?w.reduce((e,t)=>e+t,0)/w.length:e}function B(){return w.reduce((e,t)=>e+t,0)}function F(e){var t=Math.floor(e),e=Math.round(60*(e-t));return(t%12==0?12:t%12)+`:${e<10?"0"+e:e} `+(t<12||24===t?"AM":"PM")}async function me(){var t=n.sessionArr;for(let e=0;e<t.length;e++){var r=moment.tz(t[e].startTime,t[e].timeZone).format(),a=moment.tz(t[e].endTime,t[e].timeZone).format();moment(a,"YYYY-MM-DD").isSameOrAfter(moment(m.lowerBound,"YYYY-MM-DD"))&&moment(r,"YYYY-MM-DD").isSameOrBefore(moment(m.upperBound,"YYYY-MM-DD"))&&pe(r,a,he(r,t[e].deepWorkIntervals,t[e].breakIntervals))}}function pe(t,r,a){for(let e=0;e<a.length-1;e++){var n=ce(t,m.timeFrame),o=ce(r,m.timeFrame),l=e%2==0?p:c,i=moment(t,"YYYY-MM-DD").isBefore(moment(m.lowerBound,"YYYY-MM-DD")),s=moment(r,"YYYY-MM-DD").isAfter(moment(m.upperBound,"YYYY-MM-DD")),u=a[e],d=a[e+1];i?24<d&&(u<24?l.push({x:o,y:[0,d-24]}):l.push({x:o,y:[u-24,d-24]})):s?u<24&&(24<d?l.push({x:n,y:[u,24]}):l.push({x:n,y:[u,d]})):24<u&&24<d?l.push({x:o,y:[u-24,d-24]}):24<d?(l.push({x:n,y:[u,24]}),l.push({x:o,y:[0,d-24]})):l.push({x:n,y:[u,d]})}}function ce(e,t){e=(e=e.split("T")[0]).split("-"),e=new Date(e[0],e[1]-1,e[2]);return"week"===t?["Sun","Mon","Tue","Wed","Thur","Fri","Sat"][e.getDay()]:"month"===t?e.getDate().toString():"year"===t?["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"][e.getMonth()]:null}function he(e,t,r){var a=ye(t,r),n=[];let o=ge(e);n.push(o);for(let e=0;e<a.length;e++)o+=a[e]/l.msPerHour,n.push(o);return n}function ge(e){e=moment.parseZone(e);return e.hours()+e.minutes()/60+e.seconds()/3600}function ye(t,r){var a=[];for(let e=0;e<t.length;e++)a.push(t[e]),r[e]&&a.push(r[e]);return a}async function ve(){i=[],u=[],d=[],D=[],p=[],c=[],Object.keys(v).forEach(e=>{v[e]=0}),Y=[],W.month=[],w=[],M=[],a=[],s=[],N.forEach(e=>{e.style.display="none",e.style.opacity="0"}),k.populated365Arrs=!1}async function be(e,r,a,n,o,l){var i=[0,0,0,0,0,0,0,0,0,0,0,0],s=[0,0,0,0,0,0,0,0,0,0,0,0],u=[[],[],[],[],[],[],[],[],[],[],[],[]],t=e.dailyArr;for(let e=0;e<t.length;e++){var d=t[e].date;if(moment(d,"YYYY-MM-DD").isSameOrAfter(moment(r.lowerBound,"YYYY-MM-DD"))&&moment(d,"YYYY-MM-DD").isSameOrBefore(moment(r.upperBound,"YYYY-MM-DD"))){var m=S(t[e])[0],p=S(t[e])[1],c=Be(t[e]),h=Ae(d);if(w.push(m),M.push(t[e].distractions),"week"===r.timeFrame){for(var g=Ye(d);a.length<g;)a.push(0),n.push(0),o.push(0);Me(h,g)}else if("month"===r.timeFrame){for(var y=De(d);a.length<y;)a.push(0),n.push(0),o.push(0);Me(h,y)}else{h=we(d);i[h]+=t[e].deepWorkTime,s[h]+=t[e].distractions,k.avgBreakIntervalToggle?u[h].push(...t[e].breakIntervals):u[h].push(...t[e].deepWorkIntervals)}"year"!==r.timeFrame&&(a.push(m),n.push(Math.floor(100*p)),o.push(c))}}if("month"===r.timeFrame&&(e=Ie(r.lowerBound),W.month=We(e),D=fe(r.lowerBound,W.month)),k.populated365Arrs=!0,"year"===r.timeFrame){let t=!1;for(let e=l.avgInterval=0;e<12;e++){var v,b={deepWorkTime:i[e],distractions:s[e],deepWorkIntervals:u[e],breakIntervals:u[e]},f=(0!==i[e]?(f=S(b)[0],v=S(b)[1],b=Be(b),a.push(f),n.push(Math.floor(100*v)),o.push(b),t=!0):(a.push(0),n.push(0),o.push(0)),ke(r.lowerBound,e));Y.push(f)}t||(a.length=0,n.length=0,o.length=0)}l.deepWork=Te(l.deepWork),l.avgInterval=Ce(l.avgInterval)}function fe(e,t){let[r,a]=e.split("-").map(Number),n=[];return t.forEach((e,t)=>{0===new Date(r,a-1,Number(e)).getDay()&&n.push(t)}),n}function ke(e,t){e=e.split("-")[0];return["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"][t]+", "+e}function we(e){e=e.split("-")[1];return parseInt(e,10)-1}function Me(e,t){if(Y.length!==t)for(;Y.length<t;)Y.push("no data");Y.push(e)}function De(e){var[e,t,r]=e.split("-").map(Number);return new Date(e,t-1,r).getDate()-1}function Ye(e){var[e,t,r]=e.split("-").map(Number);return new Date(e,t-1,r).getDay()}function We(t){var r=[];for(let e=1;e<=t;e++)r.push(String(e));return r}function Ie(e){var[e,t]=e.split("-").map(Number);return new Date(e,t,0).getDate()}function Ae(e){var[,t,r]=e.split("-"),t=["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"][parseInt(t)-1];r=parseInt(r)+function(e){if(3<e&&e<21)return"th";switch(e%10){case 1:return"st";case 2:return"nd";case 3:return"rd";default:return"th"}}(parseInt(r)),e=Ye(e);return W.week[e]+`, ${t} `+r}function Te(e){let t=Math.ceil(e);return xe(t)&&2<t&&t++,t}function Ce(e){return 2*Math.ceil(e/2)}function xe(t){if(t<=1)return!1;if(!(t<=3)){if(t%2==0||t%3==0)return!1;for(let e=5;e*e<=t;e+=6)if(t%e==0||t%(e+2)==0)return!1}return!0}function Be(e){k.populated365Arrs||(a.push(...e.deepWorkIntervals),s.push(...e.breakIntervals));let t;t=k.avgBreakIntervalToggle?e.breakIntervals.reduce((e,t)=>e+t,0)/e.breakIntervals.length:e.deepWorkIntervals.reduce((e,t)=>e+t,0)/e.deepWorkIntervals.length;e=Math.round(t/l.msPerMin);return e>v.avgInterval&&(v.avgInterval=e),e}function S(e){let t=e.deepWorkTime/l.msPerHour;var r=60*t;t>v.deepWork&&(v.deepWork=t);let a=1-e.distractions/r/h;return a<0?a=0:isNaN(a)&&(a=1),k.adjustedDeepWorkToggle&&(t*=a),[t,a]}function Fe(){let e;e="week"===m.timeFrame?W.week:"month"===m.timeFrame?W.month:W.year;let t;t=k.adjustedDeepWorkToggle?"#0cce63":"rgba(63, 210, 68, 1)",v.deepWork<6&&(v.deepWork=6),0===i.length&&(v.deepWork=0);var r=document.getElementById("deepWorkChart").getContext("2d"),a={type:"bar",data:{labels:e,datasets:[{label:"Deep Work Hours",data:i,backgroundColor:t,borderColor:"rgb(255, 255, 255)",borderRadius:25,borderSkipped:!1,barPercentage:1,categoryPercentage:.5}]},options:{scales:{y:{beginAtZero:!0,max:v.deepWork,title:{display:!0,text:"Deep Work Hours",color:"white"},ticks:{color:"white",stepSize:1},grid:{display:!0,color:"rgba(255, 255, 255, 0.15)",lineWidth:1,drawBorder:!0,drawOnChartArea:!0,drawTicks:!1}},x:{title:{display:!1},ticks:{color:"white"}}},plugins:{legend:{display:!1},tooltip:{enabled:!0,backgroundColor:"rgb(0, 0, 0)",titleColor:"white",bodyColor:"white",borderColor:"white",borderWidth:2,callbacks:{title:function(e){e=e[0].dataIndex;return""+Y[e]},label:function(e){var t=Math.floor(e.raw);return` ${t}h ${Math.round(60*(e.raw-t))}m`}}}},animations:{x:{duration:0},y:{duration:k.quickerChartAnimations?500:1e3,easing:"easeOutQuint"}}},plugins:[P,O]};o.deepWork&&(o.deepWork.destroy(),o.deepWork=null),o.deepWork=new Chart(r,a)}function Se(){let e;if("week"===m.timeFrame)e=W.week;else if("month"===m.timeFrame){e=W.month;for(let e=0;e<u.length;e++)"no data"===Y[e]&&(u[e]=null)}else e=W.year;let t="bar";"month"===m.timeFrame&&(t="line");let r={beginAtZero:!0,suggestedMax:100,title:{display:!0,text:"Focus Quality %",color:"white"},ticks:{color:"white"},grid:{display:!0,color:"rgba(255, 255, 255, 0.15)",lineWidth:1,drawBorder:!0,drawOnChartArea:!0,drawTicks:!1}};0===u.length&&(r={beginAtZero:!0,max:0,title:{display:!0,text:"Focus Quality %",color:"white"},ticks:{color:"white"},grid:{display:!0,color:"rgba(255, 255, 255, 0.15)",lineWidth:1,drawBorder:!0,drawOnChartArea:!0,drawTicks:!1}});var a=document.getElementById("focusQualityChart").getContext("2d"),n={type:t,data:{labels:e,datasets:[{label:"Focus Quality %",data:u,backgroundColor:"rgb(162, 0, 212)",borderColor:"rgb(255, 255, 255)",borderRadius:25,borderSkipped:!1,barPercentage:1,categoryPercentage:.5,pointRadius:5,pointHoverRadius:8,spanGaps:!0,tension:.4}]},options:{scales:{y:r,x:{title:{display:!1},ticks:{color:"white"}}},plugins:{legend:{display:!1},tooltip:{enabled:!0,backgroundColor:"rgb(0, 0, 0)",titleColor:"white",bodyColor:"white",borderColor:"white",borderWidth:2,callbacks:{title:function(e){e=e[0].dataIndex;return""+Y[e]},label:function(e){var t=e.dataIndex;return"no data"===Y[t]?null:` ${e.raw}%`}}}},animations:{x:{duration:0},y:{duration:k.quickerChartAnimations?500:1e3,easing:"easeOutQuint"}}},plugins:[P,O]};o.focusQuality&&(o.focusQuality.destroy(),o.focusQuality=null),o.focusQuality=new Chart(a,n)}function Oe(){let e;e="week"===m.timeFrame?W.week:"month"===m.timeFrame?W.month:W.year;let t;t=k.avgBreakIntervalToggle?"rgba(59, 143, 227, 1)":"rgba(83, 230, 88, 1)";var r={beginAtZero:!0,max:v.avgInterval,title:{display:!0,text:"Interval Length (Min)",color:"white"},ticks:{color:"white",stepSize:10},grid:{display:!0,color:"rgba(255, 255, 255, 0.15)",lineWidth:1,drawBorder:!0,drawOnChartArea:!0,drawTicks:!1}};let a={beginAtZero:!0,suggestedMax:v.avgInterval,title:{display:!0,text:"Interval Length (Min)",color:"white"},ticks:{color:"white",stepSize:10},grid:{display:!0,color:"rgba(255, 255, 255, 0.15)",lineWidth:1,drawBorder:!0,drawOnChartArea:!0,drawTicks:!1}};v.avgInterval<60&&(v.avgInterval=60,r.max=v.avgInterval,a=r),0===d.length&&(a={beginAtZero:!0,max:0,title:{display:!0,text:"Interval Length (Min)",color:"white"},ticks:{color:"white",stepSize:10},grid:{display:!0,color:"rgba(255, 255, 255, 0.15)",lineWidth:1,drawBorder:!0,drawOnChartArea:!0,drawTicks:!1}});var r=document.getElementById("avgIntervalChart").getContext("2d"),n={type:"bar",data:{labels:e,datasets:[{label:"Interval Length (Min)",data:d,backgroundColor:t,borderColor:"rgb(255, 255, 255)",borderRadius:25,borderSkipped:!1,barPercentage:1,categoryPercentage:.5}]},options:{scales:{y:a,x:{title:{display:!1},ticks:{color:"white"}}},plugins:{legend:{display:!1},tooltip:{enabled:!0,backgroundColor:"rgb(0, 0, 0)",titleColor:"white",bodyColor:"white",borderColor:"white",borderWidth:2,callbacks:{title:function(e){e=e[0].dataIndex;return""+Y[e]},label:function(e){return` ${e.raw}m`}}}},animations:{x:{duration:0},y:{duration:k.quickerChartAnimations?500:1e3,easing:"easeOutQuint"}}},plugins:[P,O]};o.avgInterval&&(o.avgInterval.destroy(),o.avgInterval=null),o.avgInterval=new Chart(r,n)}function Pe(){let e;var t={labels:e="week"===m.timeFrame?W.week:"month"===m.timeFrame?W.month:W.year,datasets:[{label:"Deep Work",data:p,backgroundColor:"rgba(63, 210, 68, 1)",borderColor:"rgb(255, 255, 255)",borderRadius:0,borderSkipped:!1},{label:"Break",data:c,backgroundColor:"rgba(59, 143, 227, 1)",borderColor:"rgb(255, 255, 255)",borderRadius:0,borderSkipped:!1}]};let r=[],a=(r="week"===m.timeFrame?b:"month"===m.timeFrame?W.month:f,24);0===p.length&&(a=0);var n=document.getElementById("sessionIntervalsChart").getContext("2d"),t={type:"bar",data:t,options:{scales:{y:{beginAtZero:!0,min:0,max:a,reverse:!0,title:{display:!0,text:"Day",color:"white"},ticks:{stepSize:3,color:"white",callback:function(e){return 0===e||24===e?"12 AM":3===e?"3 AM":6===e?"6 AM":9===e?"9 AM":12===e?"12 PM":15===e?"3 PM":18===e?"6 PM":21===e?"9 PM":""}},grid:{display:!0,color:"rgba(255, 255, 255, 0.15)",lineWidth:1,drawBorder:!0,drawOnChartArea:!0,drawTicks:!1}},x:{stacked:!0,title:{display:!1},ticks:{color:"white"}}},plugins:{legend:{display:!0},tooltip:{enabled:!0,backgroundColor:"rgb(0, 0, 0)",titleColor:"white",bodyColor:"white",borderColor:"white",borderWidth:2,callbacks:{title:function(e){e=e.map(e=>e.label||e.xLabel).join(", "),e=r.indexOf(e);return""+Y[e]},label:function(e){return` ${F(e.raw.y[0])} - `+F(e.raw.y[1])}}}},animations:!1},plugins:[P,O]};o.sessionIntervals&&(o.sessionIntervals.destroy(),o.sessionIntervals=null),o.sessionIntervals=new Chart(n,t)}document.addEventListener("displayMainCharts",async function(){r(g),r(y),await ve(),await be(n,m,i,u,d,v);var e=ee.chartTransition;"summary"===e&&te(),"all"!==e&&"main-adjusted"!==e||Fe(),"all"===e&&Se(),"all"!==e&&"main-break"!==e||Oe(),k.quickerChartAnimations=!0,await me(),"all"===e&&Pe()});let O={id:"dottedLinePlugin",afterDraw:function(e){if("month"===m.timeFrame&&0<i.length){var t=e.ctx,r=e.scales.x,a=e.scales.y;for(let e=0;e<D.length;e++){var n=D[e],n=(r.getPixelForValue(n-1)+r.getPixelForValue(n))/2;t.save(),t.setLineDash([5,5]),t.strokeStyle="rgba(255, 255, 255, 0.15)",t.lineWidth=2,t.beginPath(),t.moveTo(n,a.top),t.lineTo(n,a.bottom),t.stroke(),t.restore()}}}},P={id:"noDataPlugin",afterDraw:function(e){var t,r;0!==e.data.datasets[0].data.length&&!e.data.datasets[0].data.every(e=>null===e)||(t=e.ctx,r=e.width,e=e.height,t.save(),t.textAlign="center",t.textBaseline="middle",t.font="48px settingsHeaderFont",t.fillStyle="gray",t.fillText("No Data 😩",r/2,e/2-20),t.restore())}};