import{dayViewCompletedTasks as i,dayViewCompletedTasksHeader as s,dayViewDeepWorkSummaryStat as e,dayViewFocusQualitySummaryStat as t,dayViewNoEntriesContainer as d,dayViewNotes as o,dayViewNotesEntriesContainer as a,dayViewNotesHeader as r,dayViewSessionsContainer as T,dayViewSummaryChart as p,sessionToDeleteContainer as O}from"../modules/dashboard-elements.js";import{charts as y,constants as v,dailyContainer as n,dashboardData as l}from"../modules/dashboard-objects.js";import{getDeepWork as V,getFocusQuality as h,getTargetHours as C}from"./session-summary-chart.js";import{userTimeZone as m}from"./identification.js";import{initializeSessionView as c}from"./session-view.js";let w,S={focusQuality:null,hours:null,minutes:null,seconds:null},u=[],g=[];async function f(){w=l.currentWeekArr[n.weekIndex]}async function E(){w={},Object.keys(S).forEach(function(e){S[e]=null}),T.innerHTML="",o.innerHTML="",i.innerHTML="",d.style.display="none",r.innerText="",s.innerText="",g=[],u=[]}function b(){let e=0;Q(e=n.dayViewSummaryChartSeen?1e3:e),n.dayViewSummaryChartSeen=!0,M(),x(),k()}function k(){var e,t,a,n;w.noteEntryData?(e=(t=w.noteEntryData).notes,t=t.completedTasks,a=e.length,n=t.length,r.innerText=`Notes (${a})`,s.innerText=`Completed Tasks (${n})`,L(a,"dayViewNote",e,o),L(n,"dayViewCompletedTask",t,i)):d.style.display="flex"}function L(t,a,n,i){for(let e=0;e<t;e++){var s=document.createElement("li"),d=(s.classList.add(a),s.innerText=n[e].content,document.createElement("span"));d.classList.add("dayViewNoteEntryTimestamp"),d.innerText=D(n[e],a,d),s.appendChild(d),i.appendChild(s)}}function D(e,t,a){let n;n="dayViewNote"===t?e.date:(a.classList.add("dayViewCompletedTaskTimestamp"),e.completionDate);let i;return i=e.timeZone||m,n=moment.tz(n,i).format("h:mm a")}function x(){if(w.dailyData){u=w.dailyData.sessions;for(let e=0;e<u.length;e++)W(u[e],e)}else N()}function W(e,t){var a=V(e.totalDeepWork),n=Math.floor(a),a=Math.round(60*(a-n));let i;e.totalDeepWork<6e4&&(i=Math.floor(e.totalDeepWork/1e3));let s,d=(s=i?i+"s":n+`h ${a}m`,1-e.totalDistractions/(e.totalDeepWork/6e4)/v.FOCUS_QUALITY_CONSTANT);d<0&&(d=0);var n=Math.floor(100*d)+"%",a=A(e.startTime,e.timeZone),o=A(e.endTime,e.timeZone),r=document.createElement("div"),t=(r.classList.add("dayViewSessionContainer"),"dayViewSession"+t),t=(r.id=t,g.push(t),document.createElement("div")),l=(t.classList.add("dayViewSessionStatOverviewContainer"),document.createElement("div")),m=(l.classList.add("dayViewSessionDeepWork"),l.innerText=s,document.createElement("div")),n=(m.classList.add("dayViewSessionFocusQuality"),m.innerText=n,t.appendChild(l),t.appendChild(m),r.appendChild(t),document.createElement("div")),l=(n.classList.add("dayViewSessionStartEndTimeContainer"),document.createElement("div")),m=(l.classList.add("dayViewSessionStartEndTime"),document.createElement("div")),t=(m.classList.add("startTimeArrowContainer"),document.createElement("img")),t=(t.src="images/icons/startTimeArrow.png",t.classList.add("startTimeArrow"),m.appendChild(t),document.createElement("div")),a=(t.classList.add("dayViewSessionStartTime"),t.textContent=a,l.appendChild(m),l.appendChild(t),document.createElement("div")),m=(a.classList.add("dayViewSessionStartEndTime"),document.createElement("div")),t=(m.classList.add("endTimeArrowContainer"),document.createElement("img")),t=(t.src="images/icons/endTimeArrow.png",t.classList.add("endTimeArrow"),m.appendChild(t),document.createElement("div")),c=(t.classList.add("dayViewSessionEndTime"),t.textContent=o,a.appendChild(m),a.appendChild(t),n.appendChild(l),n.appendChild(a),r.appendChild(n),e.deepWorkIntervals),o=I(c),u=e.breakIntervals,p=o+I(u),y=[];for(let e=0;e<c.length;e++){var h=c[e]/p*100;y.push(h),u[e]&&(h=u[e]/p*100,y.push(h))}var C=document.createElement("div");C.classList.add("dayViewSessionIntervalsContainer");for(let e=0;e<y.length;e++){var w,S=document.createElement("div"),f=(S.classList.add("dayViewSessionInterval"),S.id="dayViewSessionInterval"+e,S.style.width=y[e]+"%",document.createElement("div"));f.classList.add("dayViewSessionBlankInterval"),e%2==0?((w=document.createElement("div")).classList.add("dayViewSessionDeepWorkInterval"),S.appendChild(w),S.appendChild(f)):((w=document.createElement("div")).classList.add("dayViewSessionBreakInterval"),S.appendChild(f),S.appendChild(w)),C.appendChild(S)}r.appendChild(C),T.appendChild(r)}function I(e){return e.reduce((e,t)=>e+t,0)}function A(e,t){return moment.tz(e,t).format("h:mm A")}function N(){var e=document.createElement("div"),t=(e.classList.add("noSessionsContainer"),document.createElement("div"));t.classList="noSessions no-select",t.innerText="No Sessions",e.appendChild(t),T.appendChild(e)}function M(){null!==S.seconds?e.innerText=S.seconds+"s":e.innerText=`${S.hours}h ${S.minutes}m`,t.innerText=S.focusQuality+"%"}function Q(e){var t=document.getElementById("dayViewSummaryChart").getContext("2d");let a=0,n=0,i=1e-16,s=(w.dailyData&&((a=1-w.dailyData.distractions/(w.dailyData.deepWorkTime/6e4)/v.FOCUS_QUALITY_CONSTANT)<0&&(a=0),n=w.dailyData.deepWorkTime,i=w.dailyData.targetHourSum),h(a));var d=100-(S.focusQuality=s),o=V(n);let r=C(i)-o,l=(r<0&&(r=0),Math.floor(o)),m=Math.round(60*(o-l)),c=(S.hours=l,S.minutes=m,!1),u;n<6e4&&(c=!0,u=Math.floor(n/1e3),S.seconds=u);d={type:"doughnut",data:{datasets:[{label:"Focus Quality",data:[s,d],backgroundColor:["rgba(59, 143, 227, 1)","rgba(59, 143, 227, 0.15)"],borderColor:["rgba(255, 255, 255, 1)","rgba(255, 255, 255, 1)"],borderWidth:0},{label:"Deep Work",data:[o,r],backgroundColor:["rgba(83, 230, 88, 1)","rgba(83, 230, 88, 0.15)"],borderColor:["rgba(255, 255, 255, 1)","rgba(255, 255, 255, 1)"],borderWidth:0}]},options:{responsive:!0,maintainAspectRatio:!0,cutout:"40%",animation:{duration:e,animateRotate:!0,animateScale:!0},plugins:{legend:{display:!1,position:"bottom",labels:{boxWidth:25,padding:25,usePointStyle:!0,textAlign:"center",generateLabels:function(a){return a.data.datasets.map((e,t)=>({text:e.label,fillStyle:e.backgroundColor[0],hidden:!a.isDatasetVisible(t),lineCap:e.borderCapStyle,lineDash:e.borderDash,lineDashOffset:e.borderDashOffset,lineJoin:e.borderJoinStyle,strokeStyle:e.borderColor[0],pointStyle:e.pointStyle,datasetIndex:t}))}}},tooltip:{filter:function(e){return 0===e.dataIndex},callbacks:{label:function(e){return 0===e.datasetIndex?" Focus Quality: "+s+"%":1===e.datasetIndex?c?" Deep Work: "+u+"s":" Deep Work: "+l+"h "+m+"m":""}}}},layout:{padding:0}}};y.dayViewSummary&&(y.dayViewSummary.destroy(),y.dayViewSummary=null,p.style.display="none",p.style.opacity=0),y.dayViewSummary=new Chart(t,d),p.style.display="flex",setTimeout(()=>{p.style.opacity=1},0)}document.addEventListener("stateUpdated",async function(){T.addEventListener("click",function(e){var t=e.target;for(let e=0;e<g.length;e++){var a,n="#"+g[e];t.closest(n)&&(n=document.getElementById(""+g[e]).cloneNode(!0),a=e+1,c(u[e],n,a))}})}),document.addEventListener("displayDayView",async function(){await E(),await f(),b()});